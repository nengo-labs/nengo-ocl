
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>nengo_ocl.clra_nonlinearities &#8212; NengoOCL 2.0.0.dev0 docs</title>
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400,400i,600|Rajdhani:700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
<link rel="stylesheet" href="https://www.nengo.ai/css/bootstrap.css" type="text/css">
<style>
  body .title-bar,
  body .documentation-source h1:after {
    background-color: #69c530;
  }
</style>
<!-- Google Tag Manager -->
<script>
 (function (w, d, s, l, i) {
   w[l] = w[l] || [];
   w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
   var f = d.getElementsByTagName(s)[0],
       j = d.createElement(s),
       dl = l != "dataLayer" ? "&l=" + l : "";
   j.async = true;
   j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
   f.parentNode.insertBefore(j, f);
 })(window, document, "script", "dataLayer", "GTM-KWCR2HN");
</script>
<!-- End Google Tag Manager -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://unpkg.com/scrollreveal"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stickyfill/2.1.0/stickyfill.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
<!-- From basic/layout.html -->
<script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
  
  
<script src="../../_static/underscore.js"></script>
  
  
<script src="../../_static/doctools.js"></script>
  
  
<script src="../../_static/language_data.js"></script>
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  </head><body class="bg-dark">

<header class="fixed-top header-top shadow-sm">
  <nav class="navbar navbar-expand-md navbar-light bg-white">
    <a class="navbar-brand" href="https://www.nengo.ai/">
      <img
        src="https://www.nengo.ai/design/_images/general-full-light.svg"
        alt="Nengo"
        class="logo"
      />
    </a>
    <button
      class="navbar-toggler"
      type="button"
      data-toggle="collapse"
      data-target="#navbar-collapse"
      aria-controls="navbar-collapse"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbar-collapse">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="https://www.nengo.ai/">What is Nengo?</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://www.nengo.ai/examples/">Examples</a>
        </li>
        <li class="nav-item dropdown active">
          <a
            class="nav-link dropdown-toggle"
            id="navbar-dropdown-docs"
            data-toggle="dropdown"
            aria-haspopup="true"
            aria-expanded="false"
            href="#"
            >Documentation</a
          >
          <div
            class="dropdown-menu shadow-lg border-0"
            aria-labelledby="navbar-dropdown-docs"
          >
            
            <a class="dropdown-item" href="https://www.nengo.ai/nengo/">Nengo core</a>
            <a class="dropdown-item" href="https://github.com/nengo/nengo-gui/">NengoGUI</a>
            <a class="dropdown-item" href="https://www.nengo.ai/nengo-dl/">NengoDL</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="https://www.nengo.ai/nengo-spa/">NengoSPA</a>
            <a class="dropdown-item" href="https://www.nengo.ai/nengo-extras/">NengoExtras</a>
            <a class="dropdown-item" href="https://arvoelke.github.io/nengolib-docs/">Nengolib</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="https://www.nengo.ai/nengo-fpga/">NengoFPGA</a>
            <a class="dropdown-item" href="https://www.nengo.ai/nengo-loihi/">NengoLoihi</a>
            <a class="dropdown-item" href="https://labs.nengo.ai/nengo-ocl/">NengoOCL</a>
            <a class="dropdown-item" href="https://github.com/project-rig/nengo_spinnaker">NengoSpiNNaker</a>
            <a class="dropdown-item" href="https://github.com/nengo-labs/nengo-mpi">NengoMPI</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="https://www.nengo.ai/keras-spiking">KerasSpiking</a>
            <a class="dropdown-item" href="https://www.nengo.ai/pytorch-spiking">PyTorchSpiking</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="https://www.nengo.ai/documentation/"
              >All documentation</a
            >
          </div>
        </li>
        <li class="nav-item dropdown">
          <a
            class="nav-link dropdown-toggle"
            id="navbar-dropdown-community"
            data-toggle="dropdown"
            aria-haspopup="true"
            aria-expanded="false"
            href="#"
            >Community</a
          >
          <div
            class="dropdown-menu shadow-lg border-0"
            aria-labelledby="navbar-dropdown-community"
          >
            <a class="dropdown-item" href="https://forum.nengo.ai">Forum</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="https://www.nengo.ai/people/"
              >People</a
            >
            <a class="dropdown-item" href="https://www.nengo.ai/summer-school/"
              >Summer school</a
            >
            <a class="dropdown-item" href="https://www.nengo.ai/contributing/"
              >Contributing</a
            >
            <a class="dropdown-item" href="https://www.nengo.ai/publications/"
              >Publications</a
            >
            <a class="dropdown-item" href="https://www.nengo.ai/videos/"
              >Videos</a
            >
            <a class="dropdown-item" href="https://www.nengo.ai/conduct/"
              >Code of conduct</a
            >
            <a class="dropdown-item" href="https://www.nengo.ai/caa/">CAA</a>
          </div>
        </li>
        <li class="nav-item">
          <a
            class="nav-link btn btn-success btn-sm text-white"
            href="https://www.nengo.ai/getting-started/"
            >Getting started</a
          >
        </li>
      </ul>
    </div>
  </nav>
</header>
<div class="main-content gradient-top">
  <div class="container-fluid">
    <div class="row"><a class="toggle-sidenav d-block d-md-none" href="#"
  ><i class="icon-close fa fa-fw fa-arrow-left"></i
  ><i class="icon-open fa fa-fw fa-arrow-right"></i
></a>
<div role="complementary" class="sidenav col-4 col-xl-3 p-0 border-right">
  <h3 class="pt-5 px-5">
    <a href="../../index.html">
      <img
        class="img-fluid documentation-image"
        src="https://www.nengo.ai/design/_images/nengo-ocl-full-light.svg"
        alt="NengoOCL"
      />
    </a>
  </h3>
<form class="px-5 py-3 my-0 border-bottom" action="../../search.html" method="get">
  <div class="form-group form-group-single">
    <input type="text" name="q" class="form-control" placeholder="Search" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
    <button type="submit" class="btn btn-link">
      <img src="https://www.nengo.ai/img/icon-search.svg" alt="Go" />
    </button>
  </div>
</form><div class="p-5 toctree">
  
    <p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API reference</a></li>
</ul>

  
  </div>
  
</div>
      

      <div class="col-12 col-md-8 col-xl-9">
        <div class="container">
          <div class="row">
            <div class="col-10 offset-1 pb-5 documentation-source" role="main">
              
              
  <h1>Source code for nengo_ocl.clra_nonlinearities</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pyopencl</span> <span class="k">as</span> <span class="nn">cl</span>
<span class="kn">from</span> <span class="nn">mako.template</span> <span class="k">import</span> <span class="n">Template</span>
<span class="kn">import</span> <span class="nn">nengo.dists</span> <span class="k">as</span> <span class="nn">nengod</span>
<span class="kn">from</span> <span class="nn">nengo.utils.numpy</span> <span class="k">import</span> <span class="n">is_number</span>
<span class="kn">from</span> <span class="nn">nengo_ocl.raggedarray</span> <span class="k">import</span> <span class="n">RaggedArray</span>
<span class="kn">from</span> <span class="nn">nengo_ocl.clraggedarray</span> <span class="k">import</span> <span class="n">CLRaggedArray</span><span class="p">,</span> <span class="n">to_device</span>
<span class="kn">from</span> <span class="nn">nengo_ocl.plan</span> <span class="k">import</span> <span class="n">Plan</span>
<span class="kn">from</span> <span class="nn">nengo_ocl.utils</span> <span class="k">import</span> <span class="n">as_ascii</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">nonelist</span><span class="p">,</span> <span class="n">round_up</span>


<span class="k">def</span> <span class="nf">get_mwgs</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">cap</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">max_work_group_size</span><span class="p">,</span> <span class="n">cap</span><span class="p">)</span>


<div class="viewcode-block" id="blockify_ij"><a class="viewcode-back" href="../../api.html#nengo_ocl.clra_nonlinearities.blockify_ij">[docs]</a><span class="k">def</span> <span class="nf">blockify_ij</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">ra</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Blockify a single matrix or vector using the offset method&quot;&quot;&quot;</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">offsets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">ra</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">):</span>
            <span class="n">inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">max_size</span><span class="p">))</span>
            <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">blockify_matrices</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">ras</span><span class="p">):</span>
    <span class="c1"># NOTE: must be contiguous</span>
    <span class="n">ras</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ras</span><span class="p">)</span>
    <span class="n">ra0</span> <span class="o">=</span> <span class="n">ras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ra</span> <span class="ow">in</span> <span class="n">ras</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">ra</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="n">ra0</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">ra</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">ra0</span><span class="o">.</span><span class="n">shape0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">ra</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="n">ra</span><span class="o">.</span><span class="n">stride0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;not contiguous&quot;</span>

    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ras</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">ra0</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">startsi</span> <span class="o">=</span> <span class="p">[</span><span class="n">ra</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">ra</span> <span class="ow">in</span> <span class="n">ras</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">))</span>
            <span class="n">size</span> <span class="o">-=</span> <span class="n">max_size</span>
            <span class="n">inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ra</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ras</span><span class="p">):</span>
                <span class="n">starts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">startsi</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">startsi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">max_size</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">blockify_matrix</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">ra</span><span class="p">):</span>
    <span class="n">sizes</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">starts</span> <span class="o">=</span> <span class="n">blockify_matrices</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="p">[</span><span class="n">ra</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">starts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">blockify_vectors</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">ras</span><span class="p">):</span>
    <span class="n">ras</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ras</span><span class="p">)</span>
    <span class="n">ra0</span> <span class="o">=</span> <span class="n">ras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ras</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra0</span><span class="p">)</span> <span class="k">if</span> <span class="n">ra0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ra</span> <span class="ow">in</span> <span class="n">ras</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">ra</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">ra</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">ra0</span><span class="o">.</span><span class="n">shape0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ras</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">ra0</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">startsi</span> <span class="o">=</span> <span class="p">[</span><span class="n">ra</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">ra</span> <span class="ow">in</span> <span class="n">ras</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">))</span>
            <span class="n">size</span> <span class="o">-=</span> <span class="n">max_size</span>
            <span class="n">inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ra</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ras</span><span class="p">):</span>
                <span class="n">starts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">startsi</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">startsi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">max_size</span> <span class="o">*</span> <span class="n">ra</span><span class="o">.</span><span class="n">stride0s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">blockify_vector</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="n">ra</span><span class="p">):</span>
    <span class="n">sizes</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">starts</span> <span class="o">=</span> <span class="n">blockify_vectors</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="p">[</span><span class="n">ra</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">starts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">plan_timeupdate</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">step</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">time</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span>
    <span class="k">assert</span> <span class="n">step</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">step</span><span class="o">.</span><span class="n">shape1s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">time</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">time</span><span class="o">.</span><span class="n">shape1s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ////////// MAIN FUNCTION //////////</span>
<span class="s2">        __kernel void timeupdate(</span>
<span class="s2">            __global const int *step_starts,</span>
<span class="s2">            __global float *step_data,</span>
<span class="s2">            __global const int *time_starts,</span>
<span class="s2">            __global float *time_data</span>
<span class="s2">        )</span>
<span class="s2">        {</span>
<span class="s2">            __global float *step = step_data + step_starts[0];</span>
<span class="s2">            __global float *time = time_data + time_starts[0];</span>
<span class="s2">            step[0] += 1;</span>
<span class="s2">            time[0] = $</span><span class="si">{dt}</span><span class="s2"> * step[0];</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">))</span>
    <span class="n">full_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span> <span class="n">step</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">)</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">timeupdate</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
    <span class="n">lsize</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_timeupdate&quot;</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">full_args</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="k">return</span> <span class="n">plan</span>


<span class="k">def</span> <span class="nf">plan_reset</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">stride0s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">Y</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">values</span><span class="o">.</span><span class="n">ctype</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ////////// MAIN FUNCTION //////////</span>
<span class="s2">        __kernel void reset(</span>
<span class="s2">            __global const $</span><span class="si">{Ytype}</span><span class="s2"> *values,</span>
<span class="s2">            __global const int *Ysizes,</span>
<span class="s2">            __global const int *Ystarts,</span>
<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *Ydata</span>
<span class="s2">        )</span>
<span class="s2">        {</span>
<span class="s2">            const int i = get_global_id(0);</span>
<span class="s2">            int n = get_global_id(1);</span>

<span class="s2">    </span><span class="si">% f</span><span class="s2">or k in range(n_per_item):</span>
<span class="s2">            if (n &lt; $</span><span class="si">{N}</span><span class="s2"> &amp;&amp; i &lt; Ysizes[n])</span>
<span class="s2">                (Ydata + Ystarts[n])[i] = values[n];</span>
<span class="s2">            n += get_global_size(1);</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndfor</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">n_per_item</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">lsize0</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">lsize1</span> <span class="o">=</span> <span class="n">get_mwgs</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">cap</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span> <span class="o">//</span> <span class="n">lsize0</span>
    <span class="c1"># lsize0 = min(256, Y.sizes.max())</span>

    <span class="n">Ysizes</span><span class="p">,</span> <span class="n">Yinds</span><span class="p">,</span> <span class="n">Ystarts</span> <span class="o">=</span> <span class="n">blockify_matrix</span><span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">clYsizes</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Ysizes</span><span class="p">)</span>
    <span class="n">clYstarts</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Ystarts</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">clvalues</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="n">Yinds</span><span class="p">])</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ysizes</span><span class="p">)</span>
    <span class="n">NN</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="n">N</span> <span class="o">//</span> <span class="n">n_per_item</span><span class="p">)</span>  <span class="c1"># ceiling division</span>
    <span class="n">lsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="n">lsize1</span><span class="p">)</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="n">round_up</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span> <span class="n">lsize1</span><span class="p">))</span>
    <span class="c1"># lsize = None</span>
    <span class="c1"># gsize = (lsize0, NN)</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Ytype</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">n_per_item</span><span class="o">=</span><span class="n">n_per_item</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">clvalues</span><span class="p">,</span>
        <span class="n">clYsizes</span><span class="p">,</span>
        <span class="n">clYstarts</span><span class="p">,</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_reset&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">full_args</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">bw_per_call</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">values</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">clYsizes</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">clYstarts</span><span class="o">.</span><span class="n">nbytes</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;groups: </span><span class="si">%d</span><span class="s2">; items: </span><span class="si">%d</span><span class="s2">; items/group: </span><span class="si">%0.1f</span><span class="s2"> [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plan</span>


<span class="k">def</span> <span class="nf">plan_copy</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">incs</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">ctype</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ////////// MAIN FUNCTION //////////</span>
<span class="s2">        __kernel void copy(</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f inc is None:</span>
<span class="s2">            __global const int *incdata,</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">            __global const int *offsets,</span>
<span class="s2">            __global const int *shape0s,</span>
<span class="s2">            __global const int *shape1s,</span>
<span class="s2">            __global const int *Xstride0s,</span>
<span class="s2">            __global const int *Xstarts,</span>
<span class="s2">            __global const $</span><span class="si">{Xtype}</span><span class="s2"> *Xdata,</span>
<span class="s2">            __global const int *Ystride0s,</span>
<span class="s2">            __global const int *Ystarts,</span>
<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *Ydata</span>
<span class="s2">        )</span>
<span class="s2">        {</span>
<span class="s2">            const int n = get_global_id(1);</span>
<span class="s2">            const int ij = get_global_id(0) + offsets[n];</span>

<span class="s2">            const int shape1 = shape1s[n];</span>
<span class="s2">            const int i = ij / shape1;</span>
<span class="s2">            const int j = ij </span><span class="si">% s</span><span class="s2">hape1;</span>
<span class="s2">            const int xo = Xstarts[n] + i*Xstride0s[n] + j;</span>
<span class="s2">            const int yo = Ystarts[n] + i*Ystride0s[n] + j;</span>

<span class="s2">            if (i &lt; shape0s[n]) {</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f inc is True:</span>
<span class="s2">                Ydata[yo] += Xdata[xo];</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">lif inc is False:</span>
<span class="s2">                Ydata[yo]  = Xdata[xo];</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">lse:</span>
<span class="s2">                if (incdata[n])  Ydata[yo] += Xdata[xo];</span>
<span class="s2">                else             Ydata[yo]  = Xdata[xo];</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">lsize0</span> <span class="o">=</span> <span class="n">get_mwgs</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">cap</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
    <span class="n">sizes</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">offsets</span> <span class="o">=</span> <span class="n">blockify_ij</span><span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

    <span class="n">lsize</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Xtype</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">Ytype</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">offsets</span><span class="p">),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape1s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">stride0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">stride0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">incs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">textconf</span><span class="p">[</span><span class="s2">&quot;inc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">incs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">textconf</span><span class="p">[</span><span class="s2">&quot;inc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">full_args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">incs</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)))</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_copy&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">full_args</span><span class="p">)</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">bw_per_call</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">Y</span><span class="o">.</span><span class="n">nbytes</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;groups: </span><span class="si">%d</span><span class="s2">; items: </span><span class="si">%d</span><span class="s2">; items/group: </span><span class="si">%0.1f</span><span class="s2"> [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plan</span>


<span class="k">def</span> <span class="nf">plan_slicedcopy</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Xinds</span><span class="p">,</span> <span class="n">Yinds</span><span class="p">,</span> <span class="n">incs</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xinds</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Yinds</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Xinds</span><span class="p">,</span> <span class="n">Yinds</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Xinds</span><span class="p">,</span> <span class="n">Yinds</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">stride0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">Xinds</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">Yinds</span><span class="o">.</span><span class="n">shape0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">ctype</span>
    <span class="k">assert</span> <span class="n">Xinds</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">Yinds</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ////////// MAIN FUNCTION //////////</span>
<span class="s2">        __kernel void slicedcopy(</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f inc is None:</span>
<span class="s2">            __global const int *incdata,</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">            __global const int *Xstride0s,</span>
<span class="s2">            __global const int *Xstarts,</span>
<span class="s2">            __global const $</span><span class="si">{Xtype}</span><span class="s2"> *Xdata,</span>
<span class="s2">            __global const int *Ystride0s,</span>
<span class="s2">            __global const int *Ystarts,</span>
<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *Ydata,</span>
<span class="s2">            __global const int *Isizes,</span>
<span class="s2">            __global const int *XIstarts,</span>
<span class="s2">            __global const int *XIdata,</span>
<span class="s2">            __global const int *YIstarts,</span>
<span class="s2">            __global const int *YIdata</span>
<span class="s2">        )</span>
<span class="s2">        {</span>
<span class="s2">            const int i = get_global_id(0);</span>
<span class="s2">            const int n = get_global_id(1);</span>
<span class="s2">            if (n &gt;= $</span><span class="si">{N}</span><span class="s2">)</span>
<span class="s2">                return;</span>

<span class="s2">            __global const $</span><span class="si">{Xtype}</span><span class="s2"> *a = Xdata + Xstarts[n];</span>
<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *b = Ydata + Ystarts[n];</span>
<span class="s2">            __global const int *aind = XIdata + XIstarts[n];</span>
<span class="s2">            __global const int *bind = YIdata + YIstarts[n];</span>
<span class="s2">            const int Xstride0 = Xstride0s[n], Ystride0 = Ystride0s[n];</span>

<span class="s2">            if (i &lt; Isizes[n]) {</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f inc is True:</span>
<span class="s2">                b[bind[i]*Ystride0] += a[aind[i]*Xstride0];</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">lif inc is False:</span>
<span class="s2">                b[bind[i]*Ystride0] = a[aind[i]*Xstride0];</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">lse:</span>
<span class="s2">                if (incdata[n])</span>
<span class="s2">                    b[bind[i]*Ystride0] += a[aind[i]*Xstride0];</span>
<span class="s2">                else</span>
<span class="s2">                    b[bind[i]*Ystride0] = a[aind[i]*Xstride0];</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">lsize0</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">lsize1</span> <span class="o">=</span> <span class="n">get_mwgs</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">//</span> <span class="n">lsize0</span>

    <span class="n">sizes</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="p">[</span><span class="n">XIstarts</span><span class="p">,</span> <span class="n">YIstarts</span><span class="p">]</span> <span class="o">=</span> <span class="n">blockify_vectors</span><span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="p">[</span><span class="n">Xinds</span><span class="p">,</span> <span class="n">Yinds</span><span class="p">])</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
    <span class="n">lsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="n">lsize1</span><span class="p">)</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="n">round_up</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">lsize1</span><span class="p">))</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Xtype</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">Ytype</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">stride0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">stride0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">sizes</span><span class="p">),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">XIstarts</span><span class="p">),</span>
        <span class="n">Xinds</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">YIstarts</span><span class="p">),</span>
        <span class="n">Yinds</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">incs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">textconf</span><span class="p">[</span><span class="s2">&quot;inc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">incs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">textconf</span><span class="p">[</span><span class="s2">&quot;inc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">full_args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">incs</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)))</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">slicedcopy</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_slicedcopy&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">full_args</span><span class="p">)</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">bw_per_call</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">Xinds</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">Xinds</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;groups: </span><span class="si">%d</span><span class="s2">; items: </span><span class="si">%d</span><span class="s2">; items/group: </span><span class="si">%0.1f</span><span class="s2"> [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">Xinds</span><span class="p">),</span>
        <span class="n">Xinds</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">Xinds</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">Xinds</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">Xinds</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plan</span>


<div class="viewcode-block" id="plan_elementwise_inc"><a class="viewcode-back" href="../../api.html#nengo_ocl.clra_nonlinearities.plan_elementwise_inc">[docs]</a><span class="k">def</span> <span class="nf">plan_elementwise_inc</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements an element-wise increment Y += alpha * A * X</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    alpha : np.ndarray or None</span>
<span class="sd">        Scalars to apply to each operation.</span>
<span class="sd">    outer : bool</span>
<span class="sd">        Perform an outer product. ``A`` and ``X`` must be vectors.</span>
<span class="sd">    inc : bool</span>
<span class="sd">        Whether to increment ``Y`` (True), or set it (False).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">outer</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape0s</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape1s</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape0s</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape1s</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape0s</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape1s</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">ctype</span>
    <span class="k">assert</span> <span class="n">A</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">ctype</span>

    <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">alpha</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">),)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        inline $</span><span class="si">{Ytype}</span><span class="s2"> get_element(</span>
<span class="s2">            __global const $</span><span class="si">{Ytype}</span><span class="s2"> *data,</span>
<span class="s2">            const int shape0, const int shape1, const int stride0,</span>
<span class="s2">            const int i, const int j</span>
<span class="s2">        )</span>
<span class="s2">        {</span>
<span class="s2">            if (shape0 == 1 &amp;&amp; shape1 == 1)</span>
<span class="s2">                return data[0];</span>
<span class="s2">            else if (shape0 == 1)</span>
<span class="s2">                return data[j];</span>
<span class="s2">            else if (shape1 == 1)</span>
<span class="s2">                return data[i * stride0];</span>
<span class="s2">            else</span>
<span class="s2">                return data[i * stride0 + j];</span>
<span class="s2">        }</span>

<span class="s2">        ////////// MAIN FUNCTION //////////</span>
<span class="s2">        __kernel void elementwise_inc(</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f alpha is not None:</span>
<span class="s2">            __global const $</span><span class="si">{Ytype}</span><span class="s2"> *alphas,</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">            __global const int *offsets,</span>
<span class="s2">            __global const int *Ashape0s,</span>
<span class="s2">            __global const int *Ashape1s,</span>
<span class="s2">            __global const int *Astride0s,</span>
<span class="s2">            __global const int *Astarts,</span>
<span class="s2">            __global const $</span><span class="si">{Atype}</span><span class="s2"> *Adata,</span>
<span class="s2">            __global const int *Xshape0s,</span>
<span class="s2">            __global const int *Xshape1s,</span>
<span class="s2">            __global const int *Xstride0s,</span>
<span class="s2">            __global const int *Xstarts,</span>
<span class="s2">            __global const $</span><span class="si">{Xtype}</span><span class="s2"> *Xdata,</span>
<span class="s2">            __global const int *Yshape0s,</span>
<span class="s2">            __global const int *Yshape1s,</span>
<span class="s2">            __global const int *Ystride0s,</span>
<span class="s2">            __global const int *Ystarts,</span>
<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *Ydata</span>
<span class="s2">        )</span>
<span class="s2">        {</span>
<span class="s2">            const int n = get_global_id(1);</span>
<span class="s2">            const int ij = get_global_id(0) + offsets[n];</span>

<span class="s2">            __global const $</span><span class="si">{Atype}</span><span class="s2"> *a = Adata + Astarts[n];</span>
<span class="s2">            __global const $</span><span class="si">{Xtype}</span><span class="s2"> *x = Xdata + Xstarts[n];</span>
<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *y = Ydata + Ystarts[n];</span>

<span class="s2">            const int Ystride0 = Ystride0s[n];</span>
<span class="s2">            const int Yshape0 = Yshape0s[n];</span>
<span class="s2">            const int Yshape1 = Yshape1s[n];</span>
<span class="s2">            const int i = ij / Yshape1;</span>
<span class="s2">            const int j = ij % Yshape1;</span>

<span class="s2">    </span><span class="si">% i</span><span class="s2">f outer:</span>
<span class="s2">            const $</span><span class="si">{Atype}</span><span class="s2"> aa = get_element(a, Ashape0s[n], 1, Astride0s[n], i, 0);</span>
<span class="s2">            const $</span><span class="si">{Xtype}</span><span class="s2"> xx = get_element(x, Xshape0s[n], 1, Xstride0s[n], j, 0);</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">lse:</span>
<span class="s2">            const $</span><span class="si">{Atype}</span><span class="s2"> aa = get_element(</span>
<span class="s2">                a, Ashape0s[n], Ashape1s[n], Astride0s[n], i, j);</span>
<span class="s2">            const $</span><span class="si">{Xtype}</span><span class="s2"> xx = get_element(</span>
<span class="s2">                x, Xshape0s[n], Xshape1s[n], Xstride0s[n], i, j);</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>

<span class="s2">    </span><span class="si">% i</span><span class="s2">f alpha is not None:</span>
<span class="s2">            const $</span><span class="si">{Ytype}</span><span class="s2"> alpha = alphas[n];</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">lse:</span>
<span class="s2">            const $</span><span class="si">{Ytype}</span><span class="s2"> alpha = 1;</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>

<span class="s2">            if (i &lt; Yshape0)</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f inc:</span>
<span class="s2">                y[i*Ystride0 + j] += alpha * aa * xx;</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">lse:</span>
<span class="s2">                y[i*Ystride0 + j] = alpha * aa * xx;</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="c1"># --- blockify</span>
    <span class="n">lsize0</span> <span class="o">=</span> <span class="n">get_mwgs</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">cap</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
    <span class="n">sizes</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">offsets</span> <span class="o">=</span> <span class="n">blockify_ij</span><span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">Atype</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">Xtype</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">Ytype</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="n">outer</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="n">inc</span>
    <span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">alpha</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="n">nonelist</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">offsets</span><span class="p">),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">shape1s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">stride0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">A</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape1s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">stride0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape1s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">stride0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">elementwise_inc</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_elementwise_inc&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">full_args</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">flops_per_call</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">bw_per_call</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">A</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">X</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">Y</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">alpha</span><span class="o">.</span><span class="n">nbytes</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;groups: </span><span class="si">%d</span><span class="s2">; items: </span><span class="si">%d</span><span class="s2">; items/group: </span><span class="si">%0.1f</span><span class="s2"> [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plan</span></div>


<div class="viewcode-block" id="plan_linearfilter"><a class="viewcode-back" href="../../api.html#nengo_ocl.clra_nonlinearities.plan_linearfilter">[docs]</a><span class="k">def</span> <span class="nf">plan_linearfilter</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Xbuf</span><span class="p">,</span> <span class="n">Ybuf</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements a filter of the form</span>

<span class="sd">        y[n+1] + a[0] y[n] + ... + a[i] y[n-i] = b[0] x[n] + ... + b[j] x[n-j]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xbuf</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ybuf</span><span class="p">)</span>

    <span class="c1"># X, Y</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="c1"># A, B, Xbuf, Ybuf</span>
    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Xbuf</span><span class="p">,</span> <span class="n">Ybuf</span><span class="p">]:</span>  <span class="c1"># contiguous</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="n">arr</span><span class="o">.</span><span class="n">stride0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">]:</span>  <span class="c1"># vectors</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">((</span><span class="n">B</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Xbuf</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">shape0s</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Ybuf</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">A</span><span class="o">.</span><span class="n">shape0s</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">Xbuf</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="n">X</span><span class="o">.</span><span class="n">sizes</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">Ybuf</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">Xbuf</span><span class="o">.</span><span class="n">ctype</span>
    <span class="k">assert</span> <span class="n">Y</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">Ybuf</span><span class="o">.</span><span class="n">ctype</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ////////// MAIN FUNCTION //////////</span>
<span class="s2">        __kernel void linearfilter(</span>
<span class="s2">            __global const int *offsets,</span>
<span class="s2">            __global const int *shape0s,</span>
<span class="s2">            __global const int *shape1s,</span>
<span class="s2">            __global const int *Xstride0s,</span>
<span class="s2">            __global const int *Xstride1s,</span>
<span class="s2">            __global const int *Xstarts,</span>
<span class="s2">            __global const $</span><span class="si">{Xtype}</span><span class="s2"> *x,</span>
<span class="s2">            __global const int *Ystride0s,</span>
<span class="s2">            __global const int *Ystride1s,</span>
<span class="s2">            __global const int *Ystarts,</span>
<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *y,</span>
<span class="s2">            __global const int *Ashape0s,</span>
<span class="s2">            __global const int *Astarts,</span>
<span class="s2">            __global const $</span><span class="si">{Atype}</span><span class="s2"> *Adata,</span>
<span class="s2">            __global const int *Bshape0s,</span>
<span class="s2">            __global const int *Bstarts,</span>
<span class="s2">            __global const $</span><span class="si">{Btype}</span><span class="s2"> *Bdata,</span>
<span class="s2">            __global const int *Xbufstarts,</span>
<span class="s2">            __global $</span><span class="si">{Xtype}</span><span class="s2"> *Xbufdata,</span>
<span class="s2">            __global const int *Ybufstarts,</span>
<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *Ybufdata,</span>
<span class="s2">            __global const int *Xbufpos,</span>
<span class="s2">            __global const int *Ybufpos</span>
<span class="s2">        )</span>
<span class="s2">        {</span>
<span class="s2">            const int k = get_global_id(1);</span>
<span class="s2">            const int ij = get_global_id(0) + offsets[k];</span>

<span class="s2">            const int shape0 = shape0s[k];</span>
<span class="s2">            const int shape1 = shape1s[k];</span>
<span class="s2">            const int i = ij / shape1;</span>
<span class="s2">            const int j = ij </span><span class="si">% s</span><span class="s2">hape1;</span>
<span class="s2">            const int xij = Xstarts[k] + i*Xstride0s[k] + j*Xstride1s[k];</span>
<span class="s2">            const int yij = Ystarts[k] + i*Ystride0s[k] + j*Ystride1s[k];</span>

<span class="s2">            const int na = Ashape0s[k];</span>
<span class="s2">            const int nb = Bshape0s[k];</span>

<span class="s2">            __local $</span><span class="si">{Atype}</span><span class="s2"> a[$</span><span class="si">{na_max}</span><span class="s2">];</span>
<span class="s2">            __local $</span><span class="si">{Btype}</span><span class="s2"> b[$</span><span class="si">{nb_max}</span><span class="s2">];</span>
<span class="s2">            const int ti = get_local_id(0);</span>
<span class="s2">            if (ti &lt; na)</span>
<span class="s2">                a[ti] = (Adata + Astarts[k])[ti];</span>
<span class="s2">            if (ti &lt; nb)</span>
<span class="s2">                b[ti] = (Bdata + Bstarts[k])[ti];</span>
<span class="s2">            barrier(CLK_LOCAL_MEM_FENCE);</span>

<span class="s2">            if (i &gt;= shape0)</span>
<span class="s2">                return;</span>

<span class="s2">            if (na == 0 &amp;&amp; nb == 1) {</span>
<span class="s2">                y[yij] = b[0] * x[xij];</span>
<span class="s2">            } else if (na == 1 &amp;&amp; nb == 1) {</span>
<span class="s2">                y[yij] = b[0] * x[xij] - a[0] * y[yij];</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f uses_buf:  # save registers: only compile if needed</span>
<span class="s2">            } else {  // general filtering</span>
<span class="s2">                __global $</span><span class="si">{Xtype}</span><span class="s2"> *xbuf = Xbufdata + Xbufstarts[k];</span>
<span class="s2">                __global $</span><span class="si">{Ytype}</span><span class="s2"> *ybuf = Ybufdata + Ybufstarts[k];</span>
<span class="s2">                const int ix = Xbufpos[k];</span>
<span class="s2">                const int iy = Ybufpos[k];</span>
<span class="s2">                const int ix1 = (ix &gt; 0) ? ix - 1 : nb - 1;</span>
<span class="s2">                const int iy1 = (iy &gt; 0) ? iy - 1 : na - 1;</span>
<span class="s2">                const int size = shape0 * shape1;</span>

<span class="s2">                $</span><span class="si">{Ytype}</span><span class="s2"> yi = b[0] * x[xij];</span>
<span class="s2">                if (nb &gt; 1) {</span>
<span class="s2">                    xbuf[ix*size + ij] = x[xij];  // copy input to buffer</span>
<span class="s2">                    for (int p = 1; p &lt; nb; p++)</span>
<span class="s2">                        yi += b[p] * xbuf[((ix + p) % nb)*size + ij];</span>
<span class="s2">                }</span>

<span class="s2">                if (na &gt; 0) {</span>
<span class="s2">                    yi -= a[0] * y[yij];</span>
<span class="s2">                    if (na &gt; 1) {</span>
<span class="s2">                        for (int p = 1; p &lt; na; p++)</span>
<span class="s2">                            yi -= a[p] * ybuf[((iy + p) % na)*size + ij];</span>

<span class="s2">                        ybuf[iy1*size + ij] = yi;  // copy output to buffer</span>
<span class="s2">                    }</span>
<span class="s2">                }</span>

<span class="s2">                y[yij] = yi;</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">            }</span>
<span class="s2">        }</span>

<span class="s2">    </span><span class="si">% i</span><span class="s2">f uses_buf:  # only compile if needed</span>
<span class="s2">        __kernel void linearfilter_inc(</span>
<span class="s2">            __global const int *Ashape0s,</span>
<span class="s2">            __global const int *Bshape0s,</span>
<span class="s2">            __global int *Xbufpos,</span>
<span class="s2">            __global int *Ybufpos</span>
<span class="s2">        )</span>
<span class="s2">        {</span>
<span class="s2">            const int k = get_global_id(0);</span>
<span class="s2">            const int na = Ashape0s[k];</span>
<span class="s2">            const int nb = Bshape0s[k];</span>

<span class="s2">            const int ix = Xbufpos[k];</span>
<span class="s2">            const int iy = Ybufpos[k];</span>
<span class="s2">            Xbufpos[k] = (ix &gt; 0) ? ix - 1 : nb - 1;</span>
<span class="s2">            Ybufpos[k] = (iy &gt; 0) ? iy - 1 : na - 1;</span>
<span class="s2">        }</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">na_max</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">nb_max</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">nb_max</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="n">uses_buf</span> <span class="o">=</span> <span class="n">na_max</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nb_max</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">Xtype</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">Ytype</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">Atype</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">Btype</span><span class="o">=</span><span class="n">B</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">na_max</span><span class="o">=</span><span class="n">na_max</span><span class="p">,</span>
        <span class="n">nb_max</span><span class="o">=</span><span class="n">nb_max</span><span class="p">,</span>
        <span class="n">uses_buf</span><span class="o">=</span><span class="n">uses_buf</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>

    <span class="n">max_len</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">lsize0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">na_max</span><span class="p">,</span> <span class="n">nb_max</span><span class="p">),</span> <span class="n">get_mwgs</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">na_max</span> <span class="o">&lt;=</span> <span class="n">lsize0</span> <span class="ow">and</span> <span class="n">nb_max</span> <span class="o">&lt;=</span> <span class="n">lsize0</span>

    <span class="n">sizes</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">offsets</span> <span class="o">=</span> <span class="n">blockify_ij</span><span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>

    <span class="n">Xbufpos</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span> <span class="k">if</span> <span class="n">uses_buf</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">))</span>
    <span class="n">Ybufpos</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span> <span class="k">if</span> <span class="n">uses_buf</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">))</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">offsets</span><span class="p">),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape1s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">stride0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">stride1s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">stride0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">stride1s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">A</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">B</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Xbuf</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">Xbuf</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Ybuf</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
        <span class="n">Ybuf</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">Xbufpos</span><span class="p">,</span>
        <span class="n">Ybufpos</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># --- build and print info (change maxregcount to avoid cache, force build)</span>
    <span class="c1"># program = cl.Program(queue.context, text).build(</span>
    <span class="c1">#     options=[&#39;-cl-nv-maxrregcount=55&#39;, &#39;-cl-nv-verbose&#39;])</span>
    <span class="c1"># print(program.get_build_info(queue.device, cl.program_build_info.LOG))</span>

    <span class="n">program</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">program</span><span class="o">.</span><span class="n">linearfilter</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">lsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_linearfilter&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">full_args</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">bw_per_call</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">X</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">Y</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">A</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">B</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">Xbuf</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">Ybuf</span><span class="o">.</span><span class="n">nbytes</span>
    <span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;groups: </span><span class="si">%d</span><span class="s2">; items: </span><span class="si">%d</span><span class="s2">; items/group: </span><span class="si">%0.1f</span><span class="s2"> [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">uses_buf</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">plan</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inc</span> <span class="o">=</span> <span class="n">program</span><span class="o">.</span><span class="n">linearfilter_inc</span>
        <span class="n">inc_args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
            <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="n">inds</span><span class="p">]),</span>
            <span class="n">Xbufpos</span><span class="p">,</span>
            <span class="n">Ybufpos</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inc</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">inc_args</span><span class="p">])</span>
        <span class="n">inc_plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">gsize</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_linearfilter_inc&quot;</span><span class="p">)</span>
        <span class="n">inc_plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">inc_args</span>  <span class="c1"># prevent garbage-collection</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">plan</span><span class="p">,</span> <span class="n">inc_plan</span><span class="p">]</span></div>


<div class="viewcode-block" id="plan_probes"><a class="viewcode-back" href="../../api.html#nengo_ocl.clra_nonlinearities.plan_probes">[docs]</a><span class="k">def</span> <span class="nf">plan_probes</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : raggedarray of ints</span>
<span class="sd">        The period (in time-steps) of each probe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">periods</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">ctype</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1"># N.B.  X[i].shape = (M, N)</span>
    <span class="c1">#       Y[i].shape = (buf_len, M * N)</span>
    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">stride0s</span> <span class="o">==</span> <span class="n">X</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">stride0s</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">periods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">periods</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">cl_periods</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">periods</span><span class="p">)</span>
    <span class="n">cl_countdowns</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">periods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">cl_bufpositions</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">))</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ////////// MAIN FUNCTION //////////</span>
<span class="s2">        __kernel void probes(</span>
<span class="s2">            __global $</span><span class="si">{Ctype}</span><span class="s2"> *countdowns,</span>
<span class="s2">            __global int *bufpositions,</span>
<span class="s2">            __global const $</span><span class="si">{Ptype}</span><span class="s2"> *periods,</span>
<span class="s2">            __global const int *Xstarts,</span>
<span class="s2">            __global const int *Xshape0s,</span>
<span class="s2">            __global const int *Xshape1s,</span>
<span class="s2">            __global const $</span><span class="si">{Xtype}</span><span class="s2"> *Xdata,</span>
<span class="s2">            __global const int *Ystarts,</span>
<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *Ydata</span>
<span class="s2">        )</span>
<span class="s2">        {</span>
<span class="s2">            const int n = get_global_id(1);</span>
<span class="s2">            const $</span><span class="si">{Ctype}</span><span class="s2"> countdown = countdowns[n];</span>

<span class="s2">            if (countdown &lt;= 0) {</span>
<span class="s2">                const int n_dims = Xshape0s[n] * Xshape1s[n];</span>
<span class="s2">                __global const $</span><span class="si">{Xtype}</span><span class="s2"> *x = Xdata + Xstarts[n];</span>
<span class="s2">                const int bufpos = bufpositions[n];</span>

<span class="s2">                __global $</span><span class="si">{Ytype}</span><span class="s2"> *y = Ydata + Ystarts[n] + bufpos * n_dims;</span>

<span class="s2">                for (int ii = get_global_id(0);</span>
<span class="s2">                         ii &lt; n_dims;</span>
<span class="s2">                         ii += get_global_size(0))</span>
<span class="s2">                {</span>
<span class="s2">                    y[ii] = x[ii];</span>
<span class="s2">                }</span>
<span class="s2">                // This should *not* cause deadlock because</span>
<span class="s2">                // all local threads guaranteed to be</span>
<span class="s2">                // in this branch together.</span>
<span class="s2">                barrier(CLK_LOCAL_MEM_FENCE);</span>
<span class="s2">                if (get_global_id(0) == 0)</span>
<span class="s2">                {</span>
<span class="s2">                    countdowns[n] = countdown + periods[n] - 1;</span>
<span class="s2">                    bufpositions[n] = bufpos + 1;</span>
<span class="s2">                }</span>
<span class="s2">            }</span>
<span class="s2">            else</span>
<span class="s2">            {</span>
<span class="s2">                barrier(CLK_LOCAL_MEM_FENCE);</span>
<span class="s2">                if (get_global_id(0) == 0)</span>
<span class="s2">                {</span>
<span class="s2">                    countdowns[n] = countdown - 1;</span>
<span class="s2">                }</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span>
        <span class="n">Xtype</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">Ytype</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">Ctype</span><span class="o">=</span><span class="n">cl_countdowns</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">Ptype</span><span class="o">=</span><span class="n">cl_periods</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">cl_countdowns</span><span class="p">,</span>
        <span class="n">cl_bufpositions</span><span class="p">,</span>
        <span class="n">cl_periods</span><span class="p">,</span>
        <span class="n">X</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">X</span><span class="o">.</span><span class="n">cl_shape0s</span><span class="p">,</span>
        <span class="n">X</span><span class="o">.</span><span class="n">cl_shape1s</span><span class="p">,</span>
        <span class="n">X</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">probes</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">max_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape0s</span><span class="p">),</span> <span class="n">get_mwgs</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">max_len</span><span class="p">,</span>
        <span class="n">N</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">lsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_probes&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">full_args</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">cl_bufpositions</span> <span class="o">=</span> <span class="n">cl_bufpositions</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">bw_per_call</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">2</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">cl_periods</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">cl_countdowns</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">cl_bufpositions</span><span class="o">.</span><span class="n">nbytes</span>
    <span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;groups: </span><span class="si">%d</span><span class="s2">; items: </span><span class="si">%d</span><span class="s2">; items/group: </span><span class="si">%0.1f</span><span class="s2"> [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plan</span></div>


<span class="k">def</span> <span class="nf">plan_direct</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">input_names</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">ast_conversion</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="o">+</span> <span class="p">[</span><span class="n">output</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">stride0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">input_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">ctype</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">]</span>
    <span class="n">output_type</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">ctype</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ////////// MAIN FUNCTION //////////</span>
<span class="s2">        __kernel void direct(</span>
<span class="si">% f</span><span class="s2">or iname, itype in zip(input_names, input_types):</span>
<span class="s2">            __global const int *$</span><span class="si">{iname}</span><span class="s2">_starts__,</span>
<span class="s2">            __global const $</span><span class="si">{itype}</span><span class="s2"> *$</span><span class="si">{iname}</span><span class="s2">_data__,</span>
<span class="si">% e</span><span class="s2">ndfor</span>
<span class="s2">            __global const int *$</span><span class="si">{oname}</span><span class="s2">_starts__,</span>
<span class="s2">            __global $</span><span class="si">{otype}</span><span class="s2"> *$</span><span class="si">{oname}</span><span class="s2">_data__</span>
<span class="s2">        )</span>
<span class="s2">        {</span>
<span class="s2">            const int n = get_global_id(0);</span>
<span class="s2">            if (n &gt;= $</span><span class="si">{N}</span><span class="s2">) return;</span>

<span class="si">% f</span><span class="s2">or iname, itype in zip(input_names, input_types):</span>
<span class="s2">            __global const $</span><span class="si">{itype}</span><span class="s2"> *$</span><span class="si">{iname}</span><span class="s2"> =</span>
<span class="s2">                $</span><span class="si">{iname}</span><span class="s2">_data__ + $</span><span class="si">{iname}</span><span class="s2">_starts__[n];</span>
<span class="si">% e</span><span class="s2">ndfor</span>
<span class="s2">            __global $</span><span class="si">{otype}</span><span class="s2"> *$</span><span class="si">{oname}</span><span class="s2"> =</span>
<span class="s2">                $</span><span class="si">{oname}</span><span class="s2">_data__ + $</span><span class="si">{oname}</span><span class="s2">_starts__[n];</span>

<span class="s2">            /////vvvvv USER DECLARATIONS BELOW vvvvv</span>
<span class="s2">$</span><span class="si">{init}</span><span class="s2"></span>

<span class="s2">            /////vvvvv USER COMPUTATIONS BELOW vvvvv</span>
<span class="s2">$</span><span class="si">{code}</span><span class="s2"></span>
<span class="s2">            // END OF FUNC: put nothing after user code, since it can return</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">init</span><span class="o">=</span><span class="n">indent</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
        <span class="n">code</span><span class="o">=</span><span class="n">indent</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
        <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span>
        <span class="n">input_names</span><span class="o">=</span><span class="n">input_names</span><span class="p">,</span>
        <span class="n">input_types</span><span class="o">=</span><span class="n">input_types</span><span class="p">,</span>
        <span class="n">oname</span><span class="o">=</span><span class="n">ast_conversion</span><span class="o">.</span><span class="n">OUTPUT_NAME</span><span class="p">,</span>
        <span class="n">otype</span><span class="o">=</span><span class="n">output_type</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="n">full_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">])</span>
    <span class="n">full_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">output</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">])</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">direct</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_direct&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">full_args</span><span class="p">)</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;groups: </span><span class="si">%d</span><span class="s2">; items: </span><span class="si">%d</span><span class="s2">; items/group: </span><span class="si">%0.1f</span><span class="s2"> [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">),</span>
        <span class="n">output</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">output</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">output</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">output</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plan</span>


<span class="k">def</span> <span class="nf">plan_lif</span><span class="p">(</span>
    <span class="n">queue</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">,</span>
    <span class="n">J</span><span class="p">,</span>
    <span class="n">V</span><span class="p">,</span>
    <span class="n">W</span><span class="p">,</span>
    <span class="n">outS</span><span class="p">,</span>
    <span class="n">ref</span><span class="p">,</span>
    <span class="n">tau</span><span class="p">,</span>
    <span class="n">amp</span><span class="p">,</span>
    <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tau_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">inc_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">upsample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">fastlif</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="n">adaptive</span> <span class="o">=</span> <span class="n">N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">J</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">V</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">outS</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">J</span><span class="o">.</span><span class="n">ctype</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">outV</span><span class="o">=</span><span class="n">V</span><span class="p">,</span> <span class="n">outW</span><span class="o">=</span><span class="n">W</span><span class="p">,</span> <span class="n">outS</span><span class="o">=</span><span class="n">outS</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">adaptive</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">tau_n</span><span class="p">,</span> <span class="n">inc_n</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">N</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">J</span><span class="o">.</span><span class="n">ctype</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">))</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">outN</span><span class="o">=</span><span class="n">N</span><span class="p">))</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">tau_n</span><span class="o">=</span><span class="n">tau_n</span><span class="p">,</span> <span class="n">inc_n</span><span class="o">=</span><span class="n">inc_n</span><span class="p">))</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">J</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
        <span class="n">upsample</span><span class="o">=</span><span class="n">upsample</span><span class="p">,</span>
        <span class="n">adaptive</span><span class="o">=</span><span class="n">adaptive</span><span class="p">,</span>
        <span class="n">dtu</span><span class="o">=</span><span class="n">dt</span> <span class="o">/</span> <span class="n">upsample</span><span class="p">,</span>
        <span class="n">dtu_inv</span><span class="o">=</span><span class="n">upsample</span> <span class="o">/</span> <span class="n">dt</span><span class="p">,</span>
        <span class="n">dt_inv</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span><span class="p">,</span>
        <span class="n">fastlif</span><span class="o">=</span><span class="n">fastlif</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">decs</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        char spiked;</span>
<span class="s2">        $</span><span class="si">{type}</span><span class="s2"> dV;</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> V_threshold = 1;</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> dtu = $</span><span class="si">{dtu}</span><span class="s2">, dtu_inv = $</span><span class="si">{dtu_inv}</span><span class="s2">, dt_inv = $</span><span class="si">{dt_inv}</span><span class="s2">;</span>
<span class="si">% i</span><span class="s2">f adaptive:</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> dt = $</span><span class="si">{dt}</span><span class="s2">;</span>
<span class="si">% e</span><span class="s2">ndif</span>
<span class="si">%i</span><span class="s2">f fastlif:</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> delta_t = dtu;</span>
<span class="si">%e</span><span class="s2">lse:</span>
<span class="s2">        $</span><span class="si">{type}</span><span class="s2"> delta_t;</span>
<span class="si">%e</span><span class="s2">ndif</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="c1"># TODO: could precompute -expm1(-dtu / tau)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        spiked = 0;</span>

<span class="si">% f</span><span class="s2">or ii in range(upsample):</span>
<span class="s2">        W -= dtu;</span>
<span class="si">% i</span><span class="s2">f not fastlif:</span>
<span class="s2">        delta_t = (W &gt; dtu) ? 0 : (W &lt; 0) ? dtu : dtu - W;</span>
<span class="si">% e</span><span class="s2">ndif</span>
<span class="si">% i</span><span class="s2">f adaptive:</span>
<span class="s2">        dV = -expm1(-delta_t / tau) * (J - N - V);</span>
<span class="si">% e</span><span class="s2">lse:</span>
<span class="s2">        dV = -expm1(-delta_t / tau) * (J - V);</span>
<span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">        V += dV;</span>

<span class="si">% i</span><span class="s2">f fastlif:</span>
<span class="s2">        if (V &lt; 0 || W &gt; dtu)</span>
<span class="s2">            V = 0;</span>
<span class="s2">        else if (W &gt;= 0)</span>
<span class="s2">            V *= 1 - W * dtu_inv;</span>
<span class="si">% e</span><span class="s2">ndif</span>

<span class="s2">        if (V &gt; V_threshold) {</span>
<span class="si">% i</span><span class="s2">f fastlif:</span>
<span class="s2">            const $</span><span class="si">{type}</span><span class="s2"> overshoot = dtu * (V - V_threshold) / dV;</span>
<span class="s2">            W = ref - overshoot + dtu;</span>
<span class="si">% e</span><span class="s2">lse:</span>
<span class="s2">            const $</span><span class="si">{type}</span><span class="s2"> t_spike = dtu + tau * log1p(</span>
<span class="s2">                -(V - V_threshold) / (J - V_threshold));</span>
<span class="s2">            W = ref + t_spike;</span>
<span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">            V = 0;</span>
<span class="s2">            spiked = 1;</span>
<span class="s2">        }</span>
<span class="si">% i</span><span class="s2">f not fastlif:</span>
<span class="s2">         else if (V &lt; 0) {</span>
<span class="s2">            V = 0;</span>
<span class="s2">        }</span>
<span class="si">% e</span><span class="s2">ndif</span>

<span class="si">% e</span><span class="s2">ndfor</span>
<span class="s2">        outV = V;</span>
<span class="s2">        outW = W;</span>
<span class="s2">        outS = (spiked) ? amp*dt_inv : 0;</span>
<span class="si">% i</span><span class="s2">f adaptive:</span>
<span class="s2">        outN = N + (dt / tau_n) * (inc_n * outS - N);</span>
<span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">decs</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">decs</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">cl_name</span> <span class="o">=</span> <span class="s2">&quot;cl_alif&quot;</span> <span class="k">if</span> <span class="n">adaptive</span> <span class="k">else</span> <span class="s2">&quot;cl_lif&quot;</span>
    <span class="k">return</span> <span class="n">_plan_template</span><span class="p">(</span>
        <span class="n">queue</span><span class="p">,</span>
        <span class="n">cl_name</span><span class="p">,</span>
        <span class="n">text</span><span class="p">,</span>
        <span class="n">declares</span><span class="o">=</span><span class="n">decs</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
        <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">plan_lif_rate</span><span class="p">(</span>
    <span class="n">queue</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inc_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="k">assert</span> <span class="n">J</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">R</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">J</span><span class="o">.</span><span class="n">ctype</span>
    <span class="n">adaptive</span> <span class="o">=</span> <span class="n">N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">)</span>
    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">J</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">adaptive</span><span class="o">=</span><span class="n">adaptive</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">adaptive</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">tau_n</span><span class="p">,</span> <span class="n">inc_n</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">N</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">J</span><span class="o">.</span><span class="n">ctype</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">))</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">outN</span><span class="o">=</span><span class="n">N</span><span class="p">))</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">tau_n</span><span class="o">=</span><span class="n">tau_n</span><span class="p">,</span> <span class="n">inc_n</span><span class="o">=</span><span class="n">inc_n</span><span class="p">))</span>

    <span class="n">decs</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> c0 = 0, c1 = 1;</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f adaptive:</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> dt = $</span><span class="si">{dt}</span><span class="s2">;</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f adaptive:</span>
<span class="s2">        J = max(J - N - 1, c0);</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">lse:</span>
<span class="s2">        J = max(J - 1, c0);</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">        R = amp / (ref + tau * log1p(c1/J));</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f adaptive:</span>
<span class="s2">        outN = N + (dt / tau_n) * (inc_n*R - N);</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">decs</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">decs</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">cl_name</span> <span class="o">=</span> <span class="s2">&quot;cl_alif_rate&quot;</span> <span class="k">if</span> <span class="n">adaptive</span> <span class="k">else</span> <span class="s2">&quot;cl_lif_rate&quot;</span>
    <span class="k">return</span> <span class="n">_plan_template</span><span class="p">(</span>
        <span class="n">queue</span><span class="p">,</span>
        <span class="n">cl_name</span><span class="p">,</span>
        <span class="n">text</span><span class="p">,</span>
        <span class="n">declares</span><span class="o">=</span><span class="n">decs</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
        <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">plan_spiking_rectified_linear</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">outS</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">J</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">V</span><span class="p">,</span> <span class="n">outS</span><span class="p">,</span> <span class="n">amp</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">J</span><span class="o">.</span><span class="n">ctype</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">outV</span><span class="o">=</span><span class="n">V</span><span class="p">,</span> <span class="n">outS</span><span class="o">=</span><span class="n">outS</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">)</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">J</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt_inv</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">decs</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> c0 = 0;</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> dt = $</span><span class="si">{dt}</span><span class="s2">, dt_inv = $</span><span class="si">{dt_inv}</span><span class="s2">;</span>
<span class="s2">        $</span><span class="si">{type}</span><span class="s2"> n_spikes;</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        V += (J &gt; 0) ? dt*J : 0;</span>
<span class="s2">        n_spikes = floor(V);</span>

<span class="s2">        outV = V - n_spikes;</span>
<span class="s2">        outS = amp * n_spikes * dt_inv;</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">decs</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">decs</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">cl_name</span> <span class="o">=</span> <span class="s2">&quot;cl_spikingrelu&quot;</span>
    <span class="k">return</span> <span class="n">_plan_template</span><span class="p">(</span>
        <span class="n">queue</span><span class="p">,</span>
        <span class="n">cl_name</span><span class="p">,</span>
        <span class="n">text</span><span class="p">,</span>
        <span class="n">declares</span><span class="o">=</span><span class="n">decs</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
        <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">plan_rectified_linear</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">J</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">amp</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">J</span><span class="o">.</span><span class="n">ctype</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">J</span><span class="o">.</span><span class="n">ctype</span><span class="p">)</span>
    <span class="n">decs</span> <span class="o">=</span> <span class="s2">&quot;const $</span><span class="si">{type}</span><span class="s2"> c0 = 0;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;R = amp*max(J, c0);&quot;</span>

    <span class="n">decs</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">decs</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">cl_name</span> <span class="o">=</span> <span class="s2">&quot;cl_relu&quot;</span>
    <span class="k">return</span> <span class="n">_plan_template</span><span class="p">(</span>
        <span class="n">queue</span><span class="p">,</span>
        <span class="n">cl_name</span><span class="p">,</span>
        <span class="n">text</span><span class="p">,</span>
        <span class="n">declares</span><span class="o">=</span><span class="n">decs</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">),</span>
        <span class="n">outputs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">),</span>
        <span class="n">parameters</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">),</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">plan_sigmoid</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">J</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span>
    <span class="k">assert</span> <span class="n">R</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">J</span><span class="o">.</span><span class="n">ctype</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">J</span><span class="o">.</span><span class="n">ctype</span><span class="p">)</span>
    <span class="n">decs</span> <span class="o">=</span> <span class="s2">&quot;const $</span><span class="si">{type}</span><span class="s2"> c0 = 0, c1 = 1, t0 = -88, t1 = 15;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;R = J &lt; t0 ? c0 : J &gt; t1 ? c1/ref : c1 / (ref * (c1 + exp(-J)));&quot;</span>
    <span class="c1"># ^ constants for cutoffs from Theano</span>

    <span class="n">decs</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">decs</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">cl_name</span> <span class="o">=</span> <span class="s2">&quot;cl_sigmoid&quot;</span>
    <span class="k">return</span> <span class="n">_plan_template</span><span class="p">(</span>
        <span class="n">queue</span><span class="p">,</span>
        <span class="n">cl_name</span><span class="p">,</span>
        <span class="n">text</span><span class="p">,</span>
        <span class="n">declares</span><span class="o">=</span><span class="n">decs</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">),</span>
        <span class="n">outputs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">),</span>
        <span class="n">parameters</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">),</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_plan_template</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
    <span class="n">queue</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">core_text</span><span class="p">,</span>
    <span class="n">declares</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">blockify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">{},</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Template for making a plan for vector nonlinearities.</span>

<span class="sd">    This template assumes that all inputs and outputs are vectors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    blockify : bool</span>
<span class="sd">        If true, divide the inputs up into blocks with a maximum size.</span>

<span class="sd">    inputs: dictionary of CLRaggedArrays</span>
<span class="sd">        Inputs to the function. RaggedArrays must be a list of vectors.</span>

<span class="sd">    outputs: dictionary of CLRaggedArrays</span>
<span class="sd">        Outputs of the function. RaggedArrays must be a list of vectors.</span>

<span class="sd">    parameters: dictionary of CLRaggedArrays</span>
<span class="sd">        Parameters to the function. Each RaggedArray element must be a vector</span>
<span class="sd">        of the same length of the inputs, or a scalar (to be broadcasted).</span>
<span class="sd">        Providing a float instead of a RaggedArray makes that parameter</span>
<span class="sd">        constant.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># input to use as reference for lengths</span>

    <span class="c1"># split parameters into static and updated params</span>
    <span class="n">static_params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># static params (hard-coded)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># variable params (updated)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">CLRaggedArray</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">elif</span> <span class="n">is_number</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="n">static_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Parameter </span><span class="si">%r</span><span class="s2"> must be CLRaggedArray or float (got </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="p">)</span>

    <span class="n">avars</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">bw_per_call</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">vname</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">assert</span> <span class="n">vname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">avars</span><span class="p">,</span> <span class="s2">&quot;Name clash&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">input0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">input0</span><span class="o">.</span><span class="n">shape0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">stride0s</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># rows contiguous</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># columns contiguous</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># vectors only</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(name)s</span><span class="s2">_starts[gind1]&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">vname</span><span class="p">}</span>
        <span class="n">avars</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">bw_per_call</span> <span class="o">+=</span> <span class="n">v</span><span class="o">.</span><span class="n">nbytes</span>

    <span class="n">ivars</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">avars</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">ovars</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">avars</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">pvars</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">avars</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">fn_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">fn_name</span><span class="o">=</span><span class="n">fn_name</span><span class="p">,</span>
        <span class="n">declares</span><span class="o">=</span><span class="n">declares</span><span class="p">,</span>
        <span class="n">core_text</span><span class="o">=</span><span class="n">core_text</span><span class="p">,</span>
        <span class="n">ivars</span><span class="o">=</span><span class="n">ivars</span><span class="p">,</span>
        <span class="n">ovars</span><span class="o">=</span><span class="n">ovars</span><span class="p">,</span>
        <span class="n">pvars</span><span class="o">=</span><span class="n">pvars</span><span class="p">,</span>
        <span class="n">static_params</span><span class="o">=</span><span class="n">static_params</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ////////// MAIN FUNCTION //////////</span>
<span class="s2">    __kernel void $</span><span class="si">{fn_name}</span><span class="s2">(</span>
<span class="si">% f</span><span class="s2">or name, [type, offset] in ivars.items():</span>
<span class="s2">        __global const int *$</span><span class="si">{name}</span><span class="s2">_starts,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *$</span><span class="si">{name}</span><span class="s2">_buf,</span>
<span class="si">% e</span><span class="s2">ndfor</span>
<span class="si">% f</span><span class="s2">or name, [type, offset] in ovars.items():</span>
<span class="s2">        __global const int *$</span><span class="si">{name}</span><span class="s2">_starts,</span>
<span class="s2">        __global $</span><span class="si">{type}</span><span class="s2"> *$</span><span class="si">{name}</span><span class="s2">_buf,</span>
<span class="si">% e</span><span class="s2">ndfor</span>
<span class="si">% f</span><span class="s2">or name, [type, offset] in pvars.items():</span>
<span class="s2">        __global const int *$</span><span class="si">{name}</span><span class="s2">_starts,</span>
<span class="s2">        __global const int *$</span><span class="si">{name}</span><span class="s2">_shape0s,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *$</span><span class="si">{name}</span><span class="s2">_buf,</span>
<span class="si">% e</span><span class="s2">ndfor</span>
<span class="s2">        __global const int *sizes</span>
<span class="s2">    )</span>
<span class="s2">    {</span>
<span class="s2">        const int gind0 = get_global_id(0);</span>
<span class="s2">        const int gind1 = get_global_id(1);</span>
<span class="s2">        if (gind1 &gt;= $</span><span class="si">{N}</span><span class="s2"> || gind0 &gt;= sizes[gind1])</span>
<span class="s2">            return;</span>

<span class="si">% f</span><span class="s2">or name, [type, offset] in ivars.items():</span>
<span class="s2">        $</span><span class="si">{type}</span><span class="s2"> $</span><span class="si">{name}</span><span class="s2"> = $</span><span class="si">{name}</span><span class="s2">_buf[$</span><span class="si">{offset}</span><span class="s2"> + gind0];</span>
<span class="si">% e</span><span class="s2">ndfor</span>
<span class="si">% f</span><span class="s2">or name, [type, offset] in ovars.items():</span>
<span class="s2">        $</span><span class="si">{type}</span><span class="s2"> $</span><span class="si">{name}</span><span class="s2">;</span>
<span class="si">% e</span><span class="s2">ndfor</span>
<span class="si">% f</span><span class="s2">or name, [type, offset] in pvars.items():</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> $</span><span class="si">{name}</span><span class="s2"> = $</span><span class="si">{name}</span><span class="s2">_buf[$</span><span class="si">{offset}</span><span class="s2"> + gind0];</span>
<span class="si">% e</span><span class="s2">ndfor</span>
<span class="si">% f</span><span class="s2">or name, [type, value] in static_params.items():</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> $</span><span class="si">{name}</span><span class="s2"> = $</span><span class="si">{value}</span><span class="s2">;</span>
<span class="si">% e</span><span class="s2">ndfor</span>
<span class="s2">        //////////////////////////////////////////////////</span>
<span class="s2">        //vvvvv USER DECLARATIONS BELOW vvvvv</span>
<span class="s2">        $</span><span class="si">{declares}</span><span class="s2"></span>
<span class="s2">        //^^^^^ USER DECLARATIONS ABOVE ^^^^^</span>
<span class="s2">        //////////////////////////////////////////////////</span>

<span class="s2">        /////vvvvv USER COMPUTATIONS BELOW vvvvv</span>
<span class="s2">        $</span><span class="si">{core_text}</span><span class="s2"></span>
<span class="s2">        /////^^^^^ USER COMPUTATIONS ABOVE ^^^^^</span>

<span class="si">% f</span><span class="s2">or name, [type, offset] in ovars.items():</span>
<span class="s2">        $</span><span class="si">{name}</span><span class="s2">_buf[$</span><span class="si">{offset}</span><span class="s2"> + gind0] = $</span><span class="si">{name}</span><span class="s2">;</span>
<span class="si">% e</span><span class="s2">ndfor</span>
<span class="s2">    }</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">blockify</span><span class="p">:</span>
        <span class="c1"># blockify to help with heterogeneous sizes</span>

        <span class="c1"># find best block size</span>
        <span class="n">block_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">for</span> <span class="n">block_size_i</span> <span class="ow">in</span> <span class="n">block_sizes</span><span class="p">:</span>
            <span class="n">sizes_i</span><span class="p">,</span> <span class="n">inds_i</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">blockify_vector</span><span class="p">(</span><span class="n">block_size_i</span><span class="p">,</span> <span class="n">input0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes_i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">:</span>
                <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes_i</span><span class="p">)</span>
                <span class="n">block_size</span> <span class="o">=</span> <span class="n">block_size_i</span>
                <span class="n">sizes</span> <span class="o">=</span> <span class="n">sizes_i</span>
                <span class="n">inds</span> <span class="o">=</span> <span class="n">inds_i</span>

        <span class="n">clsizes</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">sizes</span><span class="p">)</span>
        <span class="n">get_starts</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ras</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">starts</span><span class="p">)</span> <span class="k">for</span> <span class="n">starts</span> <span class="ow">in</span> <span class="n">blockify_vectors</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="n">ras</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">Istarts</span> <span class="o">=</span> <span class="n">get_starts</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">Ostarts</span> <span class="o">=</span> <span class="n">get_starts</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">Pstarts</span> <span class="o">=</span> <span class="n">get_starts</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">Pshape0s</span> <span class="o">=</span> <span class="p">[</span><span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="n">inds</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

        <span class="n">lsize</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>

        <span class="n">full_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vstarts</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Istarts</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">full_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">vstarts</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">vstarts</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Ostarts</span><span class="p">,</span> <span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">full_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">vstarts</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">vstarts</span><span class="p">,</span> <span class="n">vshape0s</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Pstarts</span><span class="p">,</span> <span class="n">Pshape0s</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">full_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">vstarts</span><span class="p">,</span> <span class="n">vshape0s</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">])</span>
        <span class="n">full_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clsizes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Allocate more than enough kernels in a matrix</span>
        <span class="n">lsize</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">input0</span><span class="o">.</span><span class="n">shape0s</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">input0</span><span class="p">))</span>

        <span class="n">full_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">full_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">full_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">vname</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">full_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">cl_shape0s</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">])</span>
        <span class="n">full_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input0</span><span class="o">.</span><span class="n">cl_shape0s</span><span class="p">)</span>

    <span class="n">textconf</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>
    <span class="n">fns</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">)</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">full_args</span><span class="p">)</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">bw_per_call</span> <span class="o">=</span> <span class="n">bw_per_call</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;groups: </span><span class="si">%d</span><span class="s2">; items: </span><span class="si">%d</span><span class="s2">; items/group: </span><span class="si">%0.1f</span><span class="s2"> [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">gsize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">input0</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">input0</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">input0</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">input0</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plan</span>


<span class="k">def</span> <span class="nf">create_rngs</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="c1"># max 32 states per RNG to save memory (many processes just need a few)</span>
    <span class="n">work_items</span> <span class="o">=</span> <span class="n">get_mwgs</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">cap</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">rngs</span> <span class="o">=</span> <span class="n">CLRaggedArray</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span>
        <span class="n">queue</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">work_items</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">rngs</span>


<span class="n">_init_rng_kernel</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">init_rngs</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">rngs</span><span class="p">,</span> <span class="n">seeds</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">seeds</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">rngs</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">rngs</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">rngs</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">28</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">_init_rng_kernel</span>
    <span class="k">if</span> <span class="n">_init_rng_kernel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            #define RANLUXCL_LUX 2  // do not need highest quality</span>
<span class="s2">            #include &quot;pyopencl-ranluxcl.cl&quot;</span>

<span class="s2">            ////////// MAIN FUNCTION //////////</span>
<span class="s2">            __kernel void init_rng(</span>
<span class="s2">                __global const uint *seeds,</span>
<span class="s2">                __global const int *rng_starts,</span>
<span class="s2">                __global int *rng_data</span>
<span class="s2">            )</span>
<span class="s2">            {</span>
<span class="s2">                const int i = get_global_id(0);</span>
<span class="s2">                const int k = get_global_id(1);</span>

<span class="s2">                // scale seed by 2**32 (see pyopencl-ranluxcl.cl)</span>
<span class="s2">                ulong x = (ulong)i + (ulong)seeds[k] * ((ulong)UINT_MAX + 1);</span>
<span class="s2">                __global ranluxcl_state_t *rng = rng_data + rng_starts[k];</span>
<span class="s2">                ranluxcl_init(x, rng + i);</span>
<span class="s2">            }</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">())</span>
        <span class="n">_init_rng_kernel</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">init_rng</span>

    <span class="n">cl_seeds</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">))</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl_seeds</span><span class="p">,</span> <span class="n">rngs</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span> <span class="n">rngs</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">)</span>

    <span class="n">rng_items</span> <span class="o">=</span> <span class="n">rngs</span><span class="o">.</span><span class="n">shape0s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rng_items</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">))</span>
    <span class="n">lsize</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">_init_rng_kernel</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
    <span class="n">e</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<span class="n">_dist_enums</span> <span class="o">=</span> <span class="p">{</span><span class="n">nengod</span><span class="o">.</span><span class="n">Uniform</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nengod</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">_dist_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">nengod</span><span class="o">.</span><span class="n">Uniform</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">high</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">nengod</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">std</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
<span class="p">}</span>
<span class="n">dist_header</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">#include &quot;pyopencl-ranluxcl.cl&quot;</span>

<span class="s2">inline float4 sample_dist(</span>
<span class="s2">    int dist, __global const float *params, ranluxcl_state_t *state)</span>
<span class="s2">{</span>
<span class="s2">    switch (dist) {</span>
<span class="s2">        case 0:  // Uniform (params: low, high)</span>
<span class="s2">            //return ranluxcl32(state);</span>
<span class="s2">            return params[0] + (params[1] - params[0]) * ranluxcl32(state);</span>
<span class="s2">        case 1:  // Gaussian (params: mean, std)</span>
<span class="s2">            //return 0.0f;</span>
<span class="s2">            return params[0] + params[1] * ranluxcl32norm(state);</span>
<span class="s2">        default:</span>
<span class="s2">            return 0.0f;</span>
<span class="s2">    }</span>
<span class="s2">}</span>

<span class="s2">inline float getfloat4(float4 a, int i) {</span>
<span class="s2">    switch (i) {</span>
<span class="s2">        case 0: return a.s0;</span>
<span class="s2">        case 1: return a.s1;</span>
<span class="s2">        case 2: return a.s2;</span>
<span class="s2">        case 3: return a.s3;</span>
<span class="s2">    }</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">get_dist_enums_params</span><span class="p">(</span><span class="n">dists</span><span class="p">):</span>
    <span class="n">enums</span> <span class="o">=</span> <span class="p">[</span><span class="n">_dist_enums</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dists</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">_dist_params</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dists</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">RaggedArray</span><span class="p">(</span><span class="n">enums</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">RaggedArray</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">plan_whitenoise</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dist_enums</span><span class="p">,</span> <span class="n">dist_params</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">rngs</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist_enums</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist_params</span><span class="p">)</span> <span class="o">==</span> <span class="n">scale</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">inc</span><span class="o">.</span><span class="n">size</span>

    <span class="k">assert</span> <span class="n">dist_enums</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span>
    <span class="k">assert</span> <span class="n">scale</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">inc</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span>

    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Y</span><span class="p">,</span> <span class="n">dist_enums</span><span class="p">,</span> <span class="n">dist_params</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">stride0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">dist_enums</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        $</span><span class="si">{dist_header}</span><span class="s2"></span>

<span class="s2">        ////////// MAIN FUNCTION //////////</span>
<span class="s2">        __kernel void whitenoise(</span>
<span class="s2">            __global const int *shape0s,</span>
<span class="s2">            __global const int *Ystarts,</span>
<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *Ydata,</span>
<span class="s2">            __global const int *Estarts,</span>
<span class="s2">            __global const int *Edata,</span>
<span class="s2">            __global const int *Pstarts,</span>
<span class="s2">            __global const $</span><span class="si">{Ptype}</span><span class="s2"> *Pdata,</span>
<span class="s2">            __global const int *scales,</span>
<span class="s2">            __global const int *incs,</span>
<span class="s2">            __global const int *rng_starts,</span>
<span class="s2">            __global int *rng_data</span>
<span class="s2">        )</span>
<span class="s2">        {</span>
<span class="s2">            const int i0 = get_global_id(0);</span>
<span class="s2">            const int k = get_global_id(1);</span>
<span class="s2">            const int m = shape0s[k];</span>
<span class="s2">            if (i0 &gt;= m)</span>
<span class="s2">                return;</span>

<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *y = Ydata + Ystarts[k];</span>

<span class="s2">            __global ranluxcl_state_t *gstate = rng_data + rng_starts[k];</span>
<span class="s2">            ranluxcl_state_t state = gstate[i0];</span>

<span class="s2">            const int scale = scales[k];</span>
<span class="s2">            const int inc = incs[k];</span>
<span class="s2">            const int dist_enum = *(Edata + Estarts[k]);</span>
<span class="s2">            __global const float *dist_params = Pdata + Pstarts[k];</span>

<span class="s2">            float4 samples;</span>
<span class="s2">            float sample;</span>
<span class="s2">            int samplei = 4;</span>
<span class="s2">            for (int i = i0; i &lt; m; i += get_global_size(0))</span>
<span class="s2">            {</span>
<span class="s2">                if (samplei &gt;= 4) {</span>
<span class="s2">                    samples = sample_dist(dist_enum, dist_params, &amp;state);</span>
<span class="s2">                    samplei = 0;</span>
<span class="s2">                }</span>

<span class="s2">                sample = getfloat4(samples, samplei);</span>
<span class="s2">                if (scale) sample *= $</span><span class="si">{sqrt_dt_inv}</span><span class="s2">;</span>
<span class="s2">                if (inc) y[i] += sample; else y[i] = sample;</span>
<span class="s2">                samplei++;</span>
<span class="s2">            }</span>

<span class="s2">            gstate[i0] = state;</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">Ytype</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">Ptype</span><span class="o">=</span><span class="n">dist_params</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">sqrt_dt_inv</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span>
        <span class="n">dist_header</span><span class="o">=</span><span class="n">dist_header</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_shape0s</span><span class="p">,</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">dist_enums</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">dist_enums</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">dist_params</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">dist_params</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">,</span>
        <span class="n">inc</span><span class="p">,</span>
        <span class="n">rngs</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">rngs</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">whitenoise</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">max_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">rngs</span><span class="o">.</span><span class="n">shape0s</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape0s</span><span class="p">))</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">lsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_whitenoise&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">full_args</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="k">return</span> <span class="n">plan</span>


<span class="k">def</span> <span class="nf">plan_presentinput</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">signals</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pres_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">pres_t</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pres_t</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span>

    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">signals</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">stride0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ////////// MAIN FUNCTION //////////</span>
<span class="s2">        __kernel void presentinput(</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f Ptype is not None:</span>
<span class="s2">            __global $</span><span class="si">{Ptype}</span><span class="s2"> *Pdata,</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">            __global const int *Yshape0s,</span>
<span class="s2">            __global const int *Ystarts,</span>
<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *Ydata,</span>
<span class="s2">            __global const int *Tstarts,</span>
<span class="s2">            __global $</span><span class="si">{Ttype}</span><span class="s2"> *Tdata,</span>
<span class="s2">            __global const int *Sshape0s,</span>
<span class="s2">            __global const int *Sstarts,</span>
<span class="s2">            __global $</span><span class="si">{Stype}</span><span class="s2"> *Sdata</span>
<span class="s2">        )</span>
<span class="s2">        {</span>
<span class="s2">            int i = get_global_id(0);</span>
<span class="s2">            const int k = get_global_id(1);</span>
<span class="s2">            const int m = Yshape0s[k];</span>
<span class="s2">            if (i &gt;= m)</span>
<span class="s2">                return;</span>

<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *y = Ydata + Ystarts[k];</span>
<span class="s2">            __global $</span><span class="si">{Ytype}</span><span class="s2"> *s = Sdata + Sstarts[k];</span>
<span class="s2">            const int it = *(Tdata + Tstarts[k]);</span>
<span class="s2">            const int nt = Sshape0s[k];</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f Ptype is not None:</span>
<span class="s2">            const float pt = Pdata[k];</span>
<span class="s2">            const int ti = (int)((it - 0.5f) * ($</span><span class="si">{dt}</span><span class="s2">f / pt)) % nt;</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">lse:</span>
<span class="s2">            const int ti = (int)it % nt;</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>

<span class="s2">            for (; i &lt; m; i += get_global_size(0))</span>
<span class="s2">                y[i] = s[m*ti + i];</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">Ytype</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">Ttype</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">Stype</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">Ptype</span><span class="o">=</span><span class="n">pres_t</span><span class="o">.</span><span class="n">ctype</span> <span class="k">if</span> <span class="n">pres_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">((</span><span class="n">pres_t</span><span class="p">,)</span> <span class="k">if</span> <span class="n">pres_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">())</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_shape0s</span><span class="p">,</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">t</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">t</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">cl_shape0s</span><span class="p">,</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">presentinput</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">max_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape0s</span><span class="p">),</span> <span class="n">get_mwgs</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">lsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_presentinput&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">full_args</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="k">return</span> <span class="n">plan</span>


<div class="viewcode-block" id="plan_conv2d"><a class="viewcode-back" href="../../api.html#nengo_ocl.clra_nonlinearities.plan_conv2d">[docs]</a><span class="k">def</span> <span class="nf">plan_conv2d</span><span class="p">(</span>
    <span class="n">queue</span><span class="p">,</span>
    <span class="n">X</span><span class="p">,</span>
    <span class="n">Y</span><span class="p">,</span>
    <span class="n">filters</span><span class="p">,</span>
    <span class="n">shape_in</span><span class="p">,</span>
    <span class="n">shape_out</span><span class="p">,</span>
    <span class="n">kernel_shape</span><span class="p">,</span>
    <span class="n">conv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">biases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">channels_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">transposed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        filters = ch x size_i x size_j x nf             # conv transposed</span>
<span class="sd">        filters = ch x size_i x size_j x nf x ni x nj   # local transposed</span>
<span class="sd">        biases = nf x ni x nj</span>

<span class="sd">        conv : whether this is a convolution (true) or local filtering (false)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">biases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Not tested with biases (strides may be wrong)&quot;</span>

    <span class="k">for</span> <span class="n">ary</span> <span class="ow">in</span> <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">filters</span><span class="p">]</span> <span class="o">+</span> <span class="n">nonelist</span><span class="p">(</span><span class="n">biases</span><span class="p">):</span>
        <span class="c1"># assert that arrays are contiguous</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ary</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">ary</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ary</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ary</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ary</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ary</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="n">ary</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">ary</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">ctype</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ary</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="n">ary</span><span class="o">.</span><span class="n">start</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-8</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    __kernel void conv2d(</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *x,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *f,</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f biases is not None:</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *b,</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">        __global $</span><span class="si">{type}</span><span class="s2"> *y</span>
<span class="s2">    )</span>
<span class="s2">    {</span>
<span class="s2">        const int j = get_global_id(0);</span>
<span class="s2">        const int i = get_global_id(1);</span>
<span class="s2">        const int k = get_global_id(2);</span>
<span class="s2">        const int ij = i*$</span><span class="si">{nyj}</span><span class="s2"> + j;</span>

<span class="s2">        const int tj = get_local_id(0);</span>
<span class="s2">        const int ti = get_local_id(1);</span>
<span class="s2">        const int lsizej = get_local_size(0);</span>
<span class="s2">        const int lsizei = get_local_size(1);</span>
<span class="s2">        const int lsize = lsizei * lsizej;</span>
<span class="s2">        const int tij = ti*lsizej + tj;</span>
<span class="s2">        const int j0 = (j - tj)*$</span><span class="si">{stj}</span><span class="s2"> - $</span><span class="si">{pj}</span><span class="s2">;</span>
<span class="s2">        const int i0 = (i - ti)*$</span><span class="si">{sti}</span><span class="s2"> - $</span><span class="si">{pi}</span><span class="s2">;</span>
<span class="s2">        __local $</span><span class="si">{type}</span><span class="s2"> patch[$</span><span class="si">{nipatch}</span><span class="s2">][$</span><span class="si">{njpatch}</span><span class="s2">];</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f conv:</span>
<span class="s2">        __local $</span><span class="si">{type}</span><span class="s2"> filter[${si*sj}];</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">lse:</span>
<span class="s2">        f += ij;</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">        x += $</span><span class="si">{xstart}</span><span class="s2">;</span>
<span class="s2">        y += $</span><span class="si">{ystart}</span><span class="s2">;</span>
<span class="s2">        f += $</span><span class="si">{fstart}</span><span class="s2">;</span>

<span class="s2">    </span><span class="si">% i</span><span class="s2">f biases is not None:</span>
<span class="s2">        $</span><span class="si">{type}</span><span class="s2"> out = b[$</span><span class="si">{bstart}</span><span class="s2"> + k*${nyi*nyj} + ij];</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">lse:</span>
<span class="s2">        $</span><span class="si">{type}</span><span class="s2"> out = 0;</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>

<span class="s2">        for (int c = 0; c &lt; $</span><span class="si">{nc}</span><span class="s2">; c++) {</span>

<span class="s2">            // load image section</span>
<span class="s2">            __global const $</span><span class="si">{type}</span><span class="s2"> *xc = &amp;x[c * $</span><span class="si">{xstride_c}</span><span class="s2">];</span>
<span class="s2">            for (int kij = tij; kij &lt; $</span><span class="si">{npatch}</span><span class="s2">; kij += lsize) {</span>
<span class="s2">                const int ki = kij / $</span><span class="si">{njpatch}</span><span class="s2">;</span>
<span class="s2">                const int kj = kij % $</span><span class="si">{njpatch}</span><span class="s2">;</span>
<span class="s2">                const int ii = i0 + ki;</span>
<span class="s2">                const int jj = j0 + kj;</span>
<span class="s2">                if (ii &gt;= 0 &amp;&amp; ii &lt; $</span><span class="si">{nxi}</span><span class="s2"> &amp;&amp; jj &gt;= 0 &amp;&amp; jj &lt; $</span><span class="si">{nxj}</span><span class="s2">)</span>
<span class="s2">                    patch[ki][kj] = xc[ii*$</span><span class="si">{xstride_i}</span><span class="s2"> + jj*$</span><span class="si">{xstride_j}</span><span class="s2">];</span>
<span class="s2">                else</span>
<span class="s2">                    patch[ki][kj] = 0;</span>
<span class="s2">            }</span>

<span class="s2">    </span><span class="si">% i</span><span class="s2">f conv:</span>
<span class="s2">            // load filters</span>
<span class="s2">            __global const $</span><span class="si">{type}</span><span class="s2"> *fc = f + k*$</span><span class="si">{fstride_f}</span><span class="s2"> + c*$</span><span class="si">{fstride_c}</span><span class="s2">;</span>
<span class="s2">            for (int kij = tij; kij &lt; ${si*sj}; kij += lsize) {</span>
<span class="s2">                filter[kij] = fc[kij*$</span><span class="si">{fstride_ij}</span><span class="s2">];</span>
<span class="s2">            }</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">            barrier(CLK_LOCAL_MEM_FENCE);</span>

<span class="s2">            for (int ii = 0; ii &lt; $</span><span class="si">{si}</span><span class="s2">; ii++)</span>
<span class="s2">            for (int jj = 0; jj &lt; $</span><span class="si">{sj}</span><span class="s2">; jj++)</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f conv:</span>
<span class="s2">                out += filter[ii*$</span><span class="si">{sj}</span><span class="s2">+jj] * patch[$</span><span class="si">{sti}</span><span class="s2">*ti+ii][$</span><span class="si">{stj}</span><span class="s2">*tj+jj];</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">lse:</span>
<span class="s2">                out += f[((k*$</span><span class="si">{nc}</span><span class="s2"> + c)*${si*sj} + ii*$</span><span class="si">{sj}</span><span class="s2"> + jj)*${nyi*nyj}]</span>
<span class="s2">                       * patch[$</span><span class="si">{sti}</span><span class="s2">*ti+ii][$</span><span class="si">{stj}</span><span class="s2">*tj+jj];</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>

<span class="s2">            barrier(CLK_LOCAL_MEM_FENCE);</span>
<span class="s2">        }</span>

<span class="s2">        if (i &lt; $</span><span class="si">{nyi}</span><span class="s2"> &amp;&amp; j &lt; $</span><span class="si">{nyj}</span><span class="s2">)</span>
<span class="s2">            y[k*$</span><span class="si">{ystride_f}</span><span class="s2"> + i*$</span><span class="si">{ystride_i}</span><span class="s2"> + j*$</span><span class="si">{ystride_j}</span><span class="s2">] = out;</span>
<span class="s2">    }</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">si</span><span class="p">,</span> <span class="n">sj</span> <span class="o">=</span> <span class="n">kernel_shape</span>
    <span class="n">sti</span><span class="p">,</span> <span class="n">stj</span> <span class="o">=</span> <span class="n">strides</span>
    <span class="k">if</span> <span class="n">channels_last</span><span class="p">:</span>
        <span class="n">nxi</span><span class="p">,</span> <span class="n">nxj</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">shape_in</span>
        <span class="n">nyi</span><span class="p">,</span> <span class="n">nyj</span><span class="p">,</span> <span class="n">nf</span> <span class="o">=</span> <span class="n">shape_out</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nc</span><span class="p">,</span> <span class="n">nxi</span><span class="p">,</span> <span class="n">nxj</span> <span class="o">=</span> <span class="n">shape_in</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nyi</span><span class="p">,</span> <span class="n">nyj</span> <span class="o">=</span> <span class="n">shape_out</span>

    <span class="k">if</span> <span class="n">padding</span> <span class="o">==</span> <span class="s2">&quot;valid&quot;</span><span class="p">:</span>
        <span class="n">pi</span><span class="p">,</span> <span class="n">pj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">padding</span> <span class="o">==</span> <span class="s2">&quot;same&quot;</span><span class="p">:</span>
        <span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="n">si</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">pj</span> <span class="o">=</span> <span class="p">(</span><span class="n">sj</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">padding</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">pi</span><span class="p">,</span> <span class="n">pj</span> <span class="o">=</span> <span class="n">padding</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported padding (must be &#39;same&#39;, &#39;valid&#39;, or 2-tuple)&quot;</span><span class="p">)</span>

    <span class="n">max_group</span> <span class="o">=</span> <span class="n">get_mwgs</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">cap</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">max_group</span> <span class="o">&gt;=</span> <span class="mi">32</span>
    <span class="n">lsize0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nyj</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="n">lsize1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_group</span> <span class="o">//</span> <span class="n">lsize0</span><span class="p">,</span> <span class="n">nyi</span><span class="p">)</span>
    <span class="n">lsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="n">lsize1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">round_up</span><span class="p">(</span><span class="n">nyj</span><span class="p">,</span> <span class="n">lsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nyi</span><span class="p">,</span> <span class="n">lsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">nf</span><span class="p">)</span>

    <span class="n">njpatch</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">stj</span> <span class="o">+</span> <span class="n">sj</span>
    <span class="n">nipatch</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sti</span> <span class="o">+</span> <span class="n">si</span>
    <span class="n">npatch</span> <span class="o">=</span> <span class="n">nipatch</span> <span class="o">*</span> <span class="n">njpatch</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">lsize</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">queue</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">max_work_group_size</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">npatch</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">+</span> <span class="n">conv</span> <span class="o">*</span> <span class="n">si</span> <span class="o">*</span> <span class="n">sj</span> <span class="o">*</span> <span class="n">filters</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="o">&lt;=</span> <span class="n">queue</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">local_mem_size</span>
    <span class="p">)</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">biases</span><span class="o">=</span><span class="n">biases</span><span class="p">,</span>
        <span class="n">conv</span><span class="o">=</span><span class="n">conv</span><span class="p">,</span>
        <span class="n">nf</span><span class="o">=</span><span class="n">nf</span><span class="p">,</span>
        <span class="n">nxi</span><span class="o">=</span><span class="n">nxi</span><span class="p">,</span>
        <span class="n">nxj</span><span class="o">=</span><span class="n">nxj</span><span class="p">,</span>
        <span class="n">nyi</span><span class="o">=</span><span class="n">nyi</span><span class="p">,</span>
        <span class="n">nyj</span><span class="o">=</span><span class="n">nyj</span><span class="p">,</span>
        <span class="n">nc</span><span class="o">=</span><span class="n">nc</span><span class="p">,</span>
        <span class="n">si</span><span class="o">=</span><span class="n">si</span><span class="p">,</span>
        <span class="n">sj</span><span class="o">=</span><span class="n">sj</span><span class="p">,</span>
        <span class="n">pi</span><span class="o">=</span><span class="n">pi</span><span class="p">,</span>
        <span class="n">pj</span><span class="o">=</span><span class="n">pj</span><span class="p">,</span>
        <span class="n">sti</span><span class="o">=</span><span class="n">sti</span><span class="p">,</span>
        <span class="n">stj</span><span class="o">=</span><span class="n">stj</span><span class="p">,</span>
        <span class="n">nipatch</span><span class="o">=</span><span class="n">nipatch</span><span class="p">,</span>
        <span class="n">njpatch</span><span class="o">=</span><span class="n">njpatch</span><span class="p">,</span>
        <span class="n">npatch</span><span class="o">=</span><span class="n">npatch</span><span class="p">,</span>
        <span class="n">xstride_i</span><span class="o">=</span><span class="n">nxj</span> <span class="o">*</span> <span class="p">(</span><span class="n">nc</span> <span class="k">if</span> <span class="n">channels_last</span> <span class="k">else</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">xstride_j</span><span class="o">=</span><span class="n">nc</span> <span class="k">if</span> <span class="n">channels_last</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">xstride_c</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="n">channels_last</span> <span class="k">else</span> <span class="n">nxi</span> <span class="o">*</span> <span class="n">nxj</span><span class="p">,</span>
        <span class="n">ystride_i</span><span class="o">=</span><span class="n">nyj</span> <span class="o">*</span> <span class="p">(</span><span class="n">nf</span> <span class="k">if</span> <span class="n">channels_last</span> <span class="k">else</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">ystride_j</span><span class="o">=</span><span class="n">nf</span> <span class="k">if</span> <span class="n">channels_last</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">ystride_f</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="n">channels_last</span> <span class="k">else</span> <span class="n">nyi</span> <span class="o">*</span> <span class="n">nyj</span><span class="p">,</span>
        <span class="n">fstride_ij</span><span class="o">=</span><span class="n">nc</span> <span class="o">*</span> <span class="n">nf</span><span class="p">,</span>
        <span class="n">fstride_c</span><span class="o">=</span><span class="n">nf</span><span class="p">,</span>
        <span class="n">fstride_f</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">xstart</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
        <span class="n">ystart</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
        <span class="n">fstart</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
        <span class="n">bstart</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">biases</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">biases</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">base_data</span><span class="p">,</span> <span class="n">filters</span><span class="o">.</span><span class="n">base_data</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">([]</span> <span class="k">if</span> <span class="n">biases</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">biases</span><span class="o">.</span><span class="n">base_data</span><span class="p">])</span>
        <span class="o">+</span> <span class="p">[</span><span class="n">Y</span><span class="o">.</span><span class="n">base_data</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">conv2d</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="n">full_args</span><span class="p">)</span>

    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_conv2d&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">full_args</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">flops_per_call</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nyi</span> <span class="o">*</span> <span class="n">nyj</span> <span class="o">*</span> <span class="n">nf</span> <span class="o">*</span> <span class="n">nc</span> <span class="o">*</span> <span class="n">si</span> <span class="o">*</span> <span class="n">sj</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">bw_per_call</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">X</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">filters</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">Y</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">biases</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">biases</span><span class="o">.</span><span class="n">nbytes</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;shape_in=</span><span class="si">%s</span><span class="s2">, shape_out=</span><span class="si">%s</span><span class="s2">, kernel=</span><span class="si">%s</span><span class="s2">, conv=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">shape_in</span><span class="p">,</span>
        <span class="n">shape_out</span><span class="p">,</span>
        <span class="n">kernel_shape</span><span class="p">,</span>
        <span class="n">conv</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plan</span></div>


<span class="k">def</span> <span class="nf">plan_pool2d</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ary</span> <span class="ow">in</span> <span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">]:</span>
        <span class="c1"># assert that arrays are contiguous</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ary</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">ary</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ary</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ary</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ary</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ary</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="n">ary</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">Y</span><span class="o">.</span><span class="n">ctype</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ////////// MAIN FUNCTION //////////</span>
<span class="s2">    __kernel void pool2d(</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *x,</span>
<span class="s2">        __global $</span><span class="si">{type}</span><span class="s2"> *y</span>
<span class="s2">    )</span>
<span class="s2">    {</span>
<span class="s2">        const int j = get_global_id(0);</span>
<span class="s2">        const int i = get_global_id(1);</span>
<span class="s2">        const int c = get_global_id(2);</span>

<span class="s2">        const int tj = get_local_id(0);</span>
<span class="s2">        const int ti = get_local_id(1);</span>
<span class="s2">        const int lsizej = get_local_size(0);</span>
<span class="s2">        const int lsizei = get_local_size(1);</span>
<span class="s2">        const int lsize = lsizei * lsizej;</span>
<span class="s2">        const int tij = ti*lsizej + tj;</span>
<span class="s2">        const int i0 = i - ti;</span>
<span class="s2">        const int j0 = j - tj;</span>
<span class="s2">        __local $</span><span class="si">{type}</span><span class="s2"> patch[$</span><span class="si">{nipatch}</span><span class="s2">][$</span><span class="si">{njpatch}</span><span class="s2">];</span>

<span class="s2">        x += $</span><span class="si">{Xstart}</span><span class="s2">;</span>
<span class="s2">        y += $</span><span class="si">{Ystart}</span><span class="s2">;</span>

<span class="s2">        // load image patch</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *xc = &amp;x[c * ${nxi * nxj}];</span>
<span class="s2">        for (int kij = tij; kij &lt; ${nipatch * njpatch}; kij += lsize) {</span>
<span class="s2">            const int ki = kij / $</span><span class="si">{njpatch}</span><span class="s2">;</span>
<span class="s2">            const int kj = kij % $</span><span class="si">{njpatch}</span><span class="s2">;</span>
<span class="s2">            const int ii = i0*$</span><span class="si">{sti}</span><span class="s2"> + ki;</span>
<span class="s2">            const int jj = j0*$</span><span class="si">{stj}</span><span class="s2"> + kj;</span>
<span class="s2">            if (ii &gt;= 0 &amp;&amp; ii &lt; $</span><span class="si">{nxi}</span><span class="s2"> &amp;&amp; jj &gt;= 0 &amp;&amp; jj &lt; $</span><span class="si">{nxj}</span><span class="s2">)</span>
<span class="s2">                patch[ki][kj] = xc[ii*$</span><span class="si">{nxj}</span><span class="s2"> + jj];</span>
<span class="s2">            else</span>
<span class="s2">                patch[ki][kj] = NAN;</span>
<span class="s2">        }</span>

<span class="s2">        barrier(CLK_LOCAL_MEM_FENCE);</span>

<span class="s2">        $</span><span class="si">{type}</span><span class="s2"> out = 0;</span>
<span class="s2">        int n = 0;</span>
<span class="s2">        $</span><span class="si">{type}</span><span class="s2"> xij;</span>
<span class="s2">        for (int ii = 0; ii &lt; $</span><span class="si">{si}</span><span class="s2">; ii++) {</span>
<span class="s2">        for (int jj = 0; jj &lt; $</span><span class="si">{sj}</span><span class="s2">; jj++) {</span>
<span class="s2">            xij = patch[ti*$</span><span class="si">{sti}</span><span class="s2"> + ii][tj*$</span><span class="si">{stj}</span><span class="s2"> + jj];</span>
<span class="s2">            if (!isnan(xij)) {</span>
<span class="s2">                out += xij;</span>
<span class="s2">                n++;</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        }</span>

<span class="s2">        if (i &lt; $</span><span class="si">{nyi}</span><span class="s2"> &amp;&amp; j &lt; $</span><span class="si">{nyj}</span><span class="s2">)</span>
<span class="s2">            y[c*${nyi * nyj} + i*$</span><span class="si">{nyj}</span><span class="s2"> + j] = out / n;</span>
<span class="s2">    }</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">nc</span><span class="p">,</span> <span class="n">nyi</span><span class="p">,</span> <span class="n">nyj</span><span class="p">,</span> <span class="n">nxi</span><span class="p">,</span> <span class="n">nxj</span> <span class="o">=</span> <span class="n">shape</span>
    <span class="n">si</span><span class="p">,</span> <span class="n">sj</span> <span class="o">=</span> <span class="n">pool_size</span>
    <span class="n">sti</span><span class="p">,</span> <span class="n">stj</span> <span class="o">=</span> <span class="n">strides</span>

    <span class="n">max_group</span> <span class="o">=</span> <span class="n">get_mwgs</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">cap</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">max_group</span> <span class="o">&gt;=</span> <span class="mi">32</span>
    <span class="n">lsize0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nyj</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">lsize1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nyi</span><span class="p">,</span> <span class="n">max_group</span> <span class="o">//</span> <span class="n">lsize0</span><span class="p">)</span>
    <span class="n">lsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize0</span><span class="p">,</span> <span class="n">lsize1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">round_up</span><span class="p">(</span><span class="n">nyj</span><span class="p">,</span> <span class="n">lsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nyi</span><span class="p">,</span> <span class="n">lsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">nc</span><span class="p">)</span>

    <span class="n">njpatch</span> <span class="o">=</span> <span class="n">lsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sti</span> <span class="o">+</span> <span class="n">si</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">nipatch</span> <span class="o">=</span> <span class="n">lsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">stj</span> <span class="o">+</span> <span class="n">sj</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">nipatch</span> <span class="o">*</span> <span class="n">njpatch</span> <span class="o">&lt;=</span> <span class="n">queue</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">local_mem_size</span> <span class="o">/</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">ctype</span><span class="p">,</span>
        <span class="n">Xstart</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
        <span class="n">Ystart</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
        <span class="n">nxi</span><span class="o">=</span><span class="n">nxi</span><span class="p">,</span>
        <span class="n">nxj</span><span class="o">=</span><span class="n">nxj</span><span class="p">,</span>
        <span class="n">nyi</span><span class="o">=</span><span class="n">nyi</span><span class="p">,</span>
        <span class="n">nyj</span><span class="o">=</span><span class="n">nyj</span><span class="p">,</span>
        <span class="n">si</span><span class="o">=</span><span class="n">si</span><span class="p">,</span>
        <span class="n">sj</span><span class="o">=</span><span class="n">sj</span><span class="p">,</span>
        <span class="n">sti</span><span class="o">=</span><span class="n">sti</span><span class="p">,</span>
        <span class="n">stj</span><span class="o">=</span><span class="n">stj</span><span class="p">,</span>
        <span class="n">nipatch</span><span class="o">=</span><span class="n">nipatch</span><span class="p">,</span>
        <span class="n">njpatch</span><span class="o">=</span><span class="n">njpatch</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">base_data</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">base_data</span><span class="p">)</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">pool2d</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="n">full_args</span><span class="p">)</span>

    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_pool2d&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">full_args</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">flops_per_call</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">size</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">bw_per_call</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">Y</span><span class="o">.</span><span class="n">nbytes</span>
    <span class="k">return</span> <span class="n">plan</span>


<span class="k">def</span> <span class="nf">plan_bcm</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">==</span> <span class="n">alpha</span><span class="o">.</span><span class="n">size</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>  <span class="c1"># vectors</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">delta</span><span class="p">,):</span>  <span class="c1"># matrices</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">theta</span><span class="o">.</span><span class="n">shape0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">pre</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">post</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">theta</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">delta</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">alpha</span><span class="o">.</span><span class="n">ctype</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    __kernel void bcm(</span>
<span class="s2">        __global const int *shape0s,</span>
<span class="s2">        __global const int *shape1s,</span>
<span class="s2">        __global const int *pre_stride0s,</span>
<span class="s2">        __global const int *pre_starts,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *pre_data,</span>
<span class="s2">        __global const int *post_stride0s,</span>
<span class="s2">        __global const int *post_starts,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *post_data,</span>
<span class="s2">        __global const int *theta_stride0s,</span>
<span class="s2">        __global const int *theta_starts,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *theta_data,</span>
<span class="s2">        __global const int *delta_stride0s,</span>
<span class="s2">        __global const int *delta_starts,</span>
<span class="s2">        __global $</span><span class="si">{type}</span><span class="s2"> *delta_data,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *alphas</span>
<span class="s2">    )</span>
<span class="s2">    {</span>
<span class="s2">        const int ij = get_global_id(0);</span>
<span class="s2">        const int k = get_global_id(1);</span>

<span class="s2">        const int shape0 = shape0s[k];</span>
<span class="s2">        const int shape1 = shape1s[k];</span>
<span class="s2">        const int i = ij / shape1;</span>
<span class="s2">        const int j = ij </span><span class="si">% s</span><span class="s2">hape1;</span>

<span class="s2">        __global $</span><span class="si">{type}</span><span class="s2"> *delta = delta_data + delta_starts[k];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> pre = pre_data[pre_starts[k] + j*pre_stride0s[k]];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> post = post_data[post_starts[k] + i*post_stride0s[k]];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> theta = theta_data[</span>
<span class="s2">            theta_starts[k] + i*theta_stride0s[k]];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> alpha = alphas[k];</span>

<span class="s2">        if (i &lt; shape0) {</span>
<span class="s2">            delta[i*delta_stride0s[k] + j] =</span>
<span class="s2">                alpha * post * (post - theta) * pre;</span>
<span class="s2">        }</span>
<span class="s2">    }</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">ctype</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_shape0s</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_shape1s</span><span class="p">,</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">post</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">post</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">post</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">theta</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">theta</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">theta</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">bcm</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">lsize</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_bcm&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">full_args</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">flops_per_call</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">delta</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">bw_per_call</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">post</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">theta</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">delta</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">.</span><span class="n">nbytes</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plan</span>


<span class="k">def</span> <span class="nf">plan_oja</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">==</span> <span class="n">alpha</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">beta</span><span class="o">.</span><span class="n">size</span>
    <span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">):</span>  <span class="c1"># vectors</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>  <span class="c1"># matrices</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">ctype</span>
        <span class="o">==</span> <span class="n">post</span><span class="o">.</span><span class="n">ctype</span>
        <span class="o">==</span> <span class="n">weights</span><span class="o">.</span><span class="n">ctype</span>
        <span class="o">==</span> <span class="n">delta</span><span class="o">.</span><span class="n">ctype</span>
        <span class="o">==</span> <span class="n">alpha</span><span class="o">.</span><span class="n">ctype</span>
        <span class="o">==</span> <span class="n">beta</span><span class="o">.</span><span class="n">ctype</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    __kernel void oja(</span>
<span class="s2">        __global const int *shape0s,</span>
<span class="s2">        __global const int *shape1s,</span>
<span class="s2">        __global const int *pre_stride0s,</span>
<span class="s2">        __global const int *pre_starts,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *pre_data,</span>
<span class="s2">        __global const int *post_stride0s,</span>
<span class="s2">        __global const int *post_starts,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *post_data,</span>
<span class="s2">        __global const int *weights_stride0s,</span>
<span class="s2">        __global const int *weights_starts,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *weights_data,</span>
<span class="s2">        __global const int *delta_stride0s,</span>
<span class="s2">        __global const int *delta_starts,</span>
<span class="s2">        __global $</span><span class="si">{type}</span><span class="s2"> *delta_data,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *alphas,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *betas</span>
<span class="s2">    )</span>
<span class="s2">    {</span>
<span class="s2">        const int ij = get_global_id(0);</span>
<span class="s2">        const int k = get_global_id(1);</span>

<span class="s2">        const int shape0 = shape0s[k];</span>
<span class="s2">        const int shape1 = shape1s[k];</span>
<span class="s2">        const int i = ij / shape1;</span>
<span class="s2">        const int j = ij </span><span class="si">% s</span><span class="s2">hape1;</span>

<span class="s2">        __global $</span><span class="si">{type}</span><span class="s2"> *delta = delta_data + delta_starts[k];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> pre = pre_data[pre_starts[k] + j*pre_stride0s[k]];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> post = post_data[post_starts[k] + i*post_stride0s[k]];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> weight = weights_data[</span>
<span class="s2">            weights_starts[k] + i*weights_stride0s[k] + j];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> alpha = alphas[k];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> beta = betas[k];</span>

<span class="s2">        if (i &lt; shape0) {</span>
<span class="s2">            delta[i*delta_stride0s[k] + j] =</span>
<span class="s2">                alpha * post * (pre - beta * weight * post);</span>
<span class="s2">        }</span>
<span class="s2">    }</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">ctype</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_shape0s</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_shape1s</span><span class="p">,</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">post</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">post</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">post</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">oja</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">lsize</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_oja&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">full_args</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">flops_per_call</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">delta</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">bw_per_call</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">nbytes</span>
        <span class="o">+</span> <span class="n">post</span><span class="o">.</span><span class="n">nbytes</span>
        <span class="o">+</span> <span class="n">weights</span><span class="o">.</span><span class="n">nbytes</span>
        <span class="o">+</span> <span class="n">delta</span><span class="o">.</span><span class="n">nbytes</span>
        <span class="o">+</span> <span class="n">alpha</span><span class="o">.</span><span class="n">nbytes</span>
        <span class="o">+</span> <span class="n">beta</span><span class="o">.</span><span class="n">nbytes</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plan</span>


<span class="k">def</span> <span class="nf">plan_voja</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">enc</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">learn</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span>
        <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
        <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
        <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
        <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
        <span class="o">==</span> <span class="n">alpha</span><span class="o">.</span><span class="n">size</span>
        <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">learn</span><span class="p">,):</span>  <span class="c1"># scalars</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>  <span class="c1"># vectors</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>  <span class="c1"># matrices</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">stride1s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">enc</span><span class="o">.</span><span class="n">shape0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">enc</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">enc</span><span class="o">.</span><span class="n">shape0s</span> <span class="o">==</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape0s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">enc</span><span class="o">.</span><span class="n">shape1s</span> <span class="o">==</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape1s</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">ctype</span>
        <span class="o">==</span> <span class="n">post</span><span class="o">.</span><span class="n">ctype</span>
        <span class="o">==</span> <span class="n">enc</span><span class="o">.</span><span class="n">ctype</span>
        <span class="o">==</span> <span class="n">delta</span><span class="o">.</span><span class="n">ctype</span>
        <span class="o">==</span> <span class="n">learn</span><span class="o">.</span><span class="n">ctype</span>
        <span class="o">==</span> <span class="n">scale</span><span class="o">.</span><span class="n">ctype</span>
        <span class="o">==</span> <span class="n">alpha</span><span class="o">.</span><span class="n">ctype</span>
    <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    __kernel void voja(</span>
<span class="s2">        __global const int *shape0s,</span>
<span class="s2">        __global const int *shape1s,</span>
<span class="s2">        __global const int *pre_stride0s,</span>
<span class="s2">        __global const int *pre_starts,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *pre_data,</span>
<span class="s2">        __global const int *post_stride0s,</span>
<span class="s2">        __global const int *post_starts,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *post_data,</span>
<span class="s2">        __global const int *enc_stride0s,</span>
<span class="s2">        __global const int *enc_starts,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *enc_data,</span>
<span class="s2">        __global const int *delta_stride0s,</span>
<span class="s2">        __global const int *delta_starts,</span>
<span class="s2">        __global $</span><span class="si">{type}</span><span class="s2"> *delta_data,</span>
<span class="s2">        __global const int *learn_starts,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *learn_data,</span>
<span class="s2">        __global const int *scale_stride0s,</span>
<span class="s2">        __global const int *scale_starts,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *scale_data,</span>
<span class="s2">        __global const $</span><span class="si">{type}</span><span class="s2"> *alphas</span>
<span class="s2">    )</span>
<span class="s2">    {</span>
<span class="s2">        const int ij = get_global_id(0);</span>
<span class="s2">        const int k = get_global_id(1);</span>

<span class="s2">        const int shape0 = shape0s[k];</span>
<span class="s2">        const int shape1 = shape1s[k];</span>
<span class="s2">        const int i = ij / shape1;</span>
<span class="s2">        const int j = ij </span><span class="si">% s</span><span class="s2">hape1;</span>

<span class="s2">        __global $</span><span class="si">{type}</span><span class="s2"> *delta = delta_data + delta_starts[k];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> pre = pre_data[pre_starts[k] + j*pre_stride0s[k]];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> post = post_data[post_starts[k] + i*post_stride0s[k]];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> enc = enc_data[enc_starts[k] + i*enc_stride0s[k] + j];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> learn = learn_data[learn_starts[k]];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> scale = scale_data[scale_starts[k] +</span>
<span class="s2">                                         i*scale_stride0s[k]];</span>
<span class="s2">        const $</span><span class="si">{type}</span><span class="s2"> alpha = alphas[k];</span>

<span class="s2">        if (i &lt; shape0) {</span>
<span class="s2">            delta[i*delta_stride0s[k] + j] =</span>
<span class="s2">                alpha * learn * post * (scale * pre - enc);</span>
<span class="s2">        }</span>
<span class="s2">    }</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">textconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">pre</span><span class="o">.</span><span class="n">ctype</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">as_ascii</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">textconf</span><span class="p">))</span>

    <span class="n">full_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_shape0s</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_shape1s</span><span class="p">,</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">post</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">post</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">post</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">enc</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">enc</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">enc</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">.</span><span class="n">cl_stride0s</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">.</span><span class="n">cl_starts</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">.</span><span class="n">cl_buf</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_fn</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">voja</span>
    <span class="n">_fn</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">full_args</span><span class="p">])</span>

    <span class="n">lsize</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">_fn</span><span class="p">,</span> <span class="n">gsize</span><span class="p">,</span> <span class="n">lsize</span><span class="o">=</span><span class="n">lsize</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cl_voja&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">full_args</span> <span class="o">=</span> <span class="n">full_args</span>  <span class="c1"># prevent garbage-collection</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">flops_per_call</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">delta</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">bw_per_call</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">nbytes</span>
        <span class="o">+</span> <span class="n">post</span><span class="o">.</span><span class="n">nbytes</span>
        <span class="o">+</span> <span class="n">enc</span><span class="o">.</span><span class="n">nbytes</span>
        <span class="o">+</span> <span class="n">delta</span><span class="o">.</span><span class="n">nbytes</span>
        <span class="o">+</span> <span class="n">learn</span><span class="o">.</span><span class="n">nbytes</span>
        <span class="o">+</span> <span class="n">scale</span><span class="o">.</span><span class="n">nbytes</span>
        <span class="o">+</span> <span class="n">alpha</span><span class="o">.</span><span class="n">nbytes</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plan</span>
</pre></div>

            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div><footer class="text-light footer-main gradient-bottom">
  <p class="small text-center mb-0">
    <a class="no-hover-line" href="https://appliedbrainresearch.com">
      <img
        src="https://appliedbrainresearch.com/img/logo-blue-notext.svg"
        height="48"
      />
    </a>
    <a href="https://www.nengo.ai/">What is Nengo?</a>
    <a href="https://www.nengo.ai/examples/">Examples</a>
    <a href="https://www.nengo.ai/documentation/">Documentation</a>
    <a href="https://www.nengo.ai/getting-started/">Getting started</a>
    <a href="https://www.nengo.ai/privacy/">Privacy</a>
  </p>
  <p class="small text-center mb-0">&copy; Applied Brain Research</p>
</footer>
<script>
  var elements = document.querySelectorAll('.sidenav');
  Stickyfill.add(elements);
</script>
<script>
  ScrollReveal().reveal(".fade-in", {
      scale: 0.85,
      duration: 1000,
      delay: 250,
      interval: 50
  });
</script>
<script>
  $('a.toggle-sidenav').on('click', function(e) {
    e.preventDefault();
    if ( $(this).hasClass('active') ) {
      $(this).removeClass('active');
      $('.sidenav').removeClass('open');
    } else {
      $(this).addClass('active');
      $('.sidenav').addClass('open');
    }
  });
</script>
<script>
  var lists = document.querySelectorAll('.toctree ul');
  lists.forEach((ul) => {
      ul.classList.add("nav");
  });
  var links = document.querySelectorAll('.toctree a');
  links.forEach((link) => {
      link.classList.add("nav-link");
  });
  $("body").scrollspy({target: ".sidenav"});
</script>
  </body>
</html>